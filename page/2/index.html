<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="æ±‚ç´¢ä¹‹å¿ƒ" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://ibitm.github.io').hostname,
    root: '/',
    scheme: 'Pisces',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="æ±‚ç´¢ä¹‹å¿ƒ">
<meta property="og:url" content="https:&#x2F;&#x2F;ibitm.github.io&#x2F;page&#x2F;2&#x2F;index.html">
<meta property="og:site_name" content="æ±‚ç´¢ä¹‹å¿ƒ">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://ibitm.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>æ±‚ç´¢ä¹‹å¿ƒ</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">æ±‚ç´¢ä¹‹å¿ƒ</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">ç‚¹æ»´ç¢ç£¨</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>å½’æ¡£</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="æœç´¢..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ibitm.github.io/2019/12/15/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20191124213944.png">
      <meta itemprop="name" content="å¼ æ½‡">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±‚ç´¢ä¹‹å¿ƒ">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/15/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">ç§’æ€ç³»ç»Ÿå­¦ä¹ ç¬”è®°</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-15 15:19:07" itemprop="dateCreated datePublished" datetime="2019-12-15T15:19:07+08:00">2019-12-15</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2019/12/15/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/12/15/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ç¯å¢ƒçš„æ­å»º"><a href="#ç¯å¢ƒçš„æ­å»º" class="headerlink" title="ç¯å¢ƒçš„æ­å»º"></a>ç¯å¢ƒçš„æ­å»º</h2><h3 id="Spring-Boot"><a href="#Spring-Boot" class="headerlink" title="Spring Boot"></a>Spring Boot</h3><p><a href="https://spring.io/projects/spring-boot/" target="_blank" rel="noopener">Spring Boot å®˜ç½‘</a></p>
<p><a href="https://spring.io/guides/gs/rest-service/" target="_blank" rel="noopener">Spring Boot æ„å»ºä¸€ä¸ª RESTFUL é£æ ¼çš„ Web æœåŠ¡</a></p>
<p>äº’ä¸ é€šä¿¡ çš„ åˆ†å¸ƒå¼ æ¶æ„ æ–¹å¼ã€‚ ç¼“å­˜ ä¸ åº”ç”¨ åˆ†ç¦» éƒ¨ç½²ï¼Œ ç¼“å­˜ ç³»ç»Ÿ éƒ¨ç½² åœ¨ ä¸€ç»„ ä¸“é—¨ çš„ æœåŠ¡å™¨ ä¸Šï¼Œ åº”ç”¨ ç¨‹åº é€šè¿‡ ä¸€è‡´æ€§ Hash ç­‰ è·¯ ç”± ç®—æ³• é€‰æ‹© ç¼“å­˜ æœåŠ¡å™¨ è¿œç¨‹ è®¿é—® ç¼“å­˜ æ•°æ®ï¼Œ ç¼“å­˜ æœåŠ¡å™¨ ä¹‹é—´ ä¸ é€šä¿¡ï¼Œ ç¼“å­˜ é›†ç¾¤ çš„ è§„æ¨¡ å¯ä»¥ å¾ˆå®¹æ˜“ åœ° å®ç° æ‰©å®¹ï¼Œ å…·æœ‰ è‰¯å¥½ çš„ å¯ ä¼¸ç¼©æ€§ã€‚</p>
<p>ææ™ºæ…§. å¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„:æ ¸å¿ƒåŸç†ä¸æ¡ˆä¾‹åˆ†æ (p. 49). ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾. Kindle ç‰ˆæœ¬. </p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ibitm.github.io/2019/12/14/%E5%85%B3%E4%BA%8E%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9%E5%A4%8D%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20191124213944.png">
      <meta itemprop="name" content="å¼ æ½‡">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±‚ç´¢ä¹‹å¿ƒ">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/14/%E5%85%B3%E4%BA%8E%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9%E5%A4%8D%E4%B9%A0/" class="post-title-link" itemprop="url">å…³äºè®¡ç®—æœºç½‘ç»œçš„çŸ¥è¯†ç‚¹å¤ä¹ ...</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-14 15:03:18" itemprop="dateCreated datePublished" datetime="2019-12-14T15:03:18+08:00">2019-12-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index">
                    <span itemprop="name">è®¡ç®—æœºç½‘ç»œ</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2019/12/14/%E5%85%B3%E4%BA%8E%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9%E5%A4%8D%E4%B9%A0/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/12/14/%E5%85%B3%E4%BA%8E%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9%E5%A4%8D%E4%B9%A0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æ—¢ç„¶å·²ç»å†³å®šè¦åšå¼€å‘äº†ï¼Œå°±æŠŠä¹‹é—´æ”¾ä¸‹çš„ä¸œè¥¿æ¡èµ·æ¥å¥½å¥½çœ‹çœ‹å§ğŸ˜</p>
<h2 id="ISO-OSI-å‚è€ƒæ¨¡å‹å’Œ-TCP-IP-æ¨¡å‹"><a href="#ISO-OSI-å‚è€ƒæ¨¡å‹å’Œ-TCP-IP-æ¨¡å‹" class="headerlink" title="ISO/OSI å‚è€ƒæ¨¡å‹å’Œ TCP/IP æ¨¡å‹"></a>ISO/OSI å‚è€ƒæ¨¡å‹å’Œ TCP/IP æ¨¡å‹</h2><p>å›½é™…æ ‡å‡†åŒ–ç»„ç»‡ (ISO)æå‡ºäº†ç½‘ç»œä½“ç³»ç»“æ„æ¨¡å‹ï¼Œç§°ä¸º<strong>å¼€æ”¾äº’è¿å‚è€ƒæ¨¡å‹</strong>ï¼ˆOSI/RMï¼‰ï¼Œç®€ç§°ä¸º <strong>OSI å‚è€ƒæ¨¡å‹</strong>ã€‚</p>
<p>å…±æœ‰ä¸ƒå±‚</p>
<h2 id="æ•°æ®äº¤æ¢çš„æ–¹å¼"><a href="#æ•°æ®äº¤æ¢çš„æ–¹å¼" class="headerlink" title="æ•°æ®äº¤æ¢çš„æ–¹å¼"></a>æ•°æ®äº¤æ¢çš„æ–¹å¼</h2><ol>
<li><p>ç”µè·¯äº¤æ¢</p>
<p>åœ¨æºèŠ‚ç‚¹å’Œç›®çš„èŠ‚ç‚¹ä¹‹é—´å»ºç«‹ä¸€æ¡ä¸“ç”¨ï¼ˆåŒæ–¹ç‹¬å ï¼‰çš„é€šè·¯ç”¨äºä¼ é€æ•°æ®ï¼Œé€šå¸¸åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼šå»ºç«‹è¿æ¥ï¼Œä¼ è¾“æ•°æ®å’Œæ–­å¼€è¿æ¥ã€‚æœ€å…¸å‹çš„ç”µè·¯äº¤æ¢ç½‘å°±æ˜¯ä¼ ç»Ÿç”µè¯ç½‘ç»œã€‚</p>
<p>ä¸»è¦ç‰¹ç‚¹æ˜¯æ•´ä¸ªæŠ¥æ–‡çš„æ¯”ç‰¹æµè¿ç»­çš„ä»æºç‚¹åˆ°è¾¾ç»ˆç‚¹ï¼Œå¥½åƒåœ¨ä¸€ä¸ªç®¡é“ä¸­ä¼ è¾“ã€‚ä¼˜ç‚¹æ˜¯æ•°æ®ç›´æ¥ä¼ é€ã€å»¶è¿Ÿå°ã€‚ç¼ºç‚¹æ˜¯çº¿è·¯åˆ©ç”¨ç‡ä½ã€ä¸èƒ½å……åˆ†åˆ©ç”¨çº¿è·¯å®¹é‡ã€‚</p>
</li>
<li><p>æŠ¥æ–‡äº¤æ¢</p>
<p>å°†ç”¨æˆ·æ•°æ®é™„åŠ ä¸Šæºåœ°å€ã€ç›®çš„åœ°å€ã€æ ¡éªŒç ç­‰è¾…åŠ©ä¿¡æ¯ï¼Œå°è£…æˆæŠ¥æ–‡ã€‚æ•´ä¸ªæŠ¥æ–‡ä¼ é€åˆ°ç›¸é‚»èŠ‚ç‚¹ï¼Œå…¨éƒ¨å­˜å‚¨è¢­æ¥åï¼Œå†è½¬å‘ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‡å¤ä¸Šè¿°è¿‡ç¨‹ç›´åˆ°åˆ°è¾¾ç›®çš„èŠ‚ç‚¹ã€‚</p>
<p>æŠ¥æ–‡äº¤æ¢ä¹Ÿç§°ä¸ºå­˜å‚¨-è½¬å‘ã€‚ä¸»è¦ç‰¹ç‚¹æ˜¯æ•´ä¸ªæŠ¥æ–‡å…ˆä¼ é€åˆ°ç›¸é‚»ç»“ç‚¹ï¼Œå…¨éƒ¨å­˜å‚¨ä¸‹æ¥åæŸ¥æ‰¾è½¬å‘è¡¨ï¼Œè½¬å‘åˆ°ä¸‹ä¸€ä¸ªç»“ç‚¹ã€‚</p>
<p>ä¼˜ç‚¹æ˜¯å¯ä»¥è¾ƒä¸ºå……åˆ†çº¿è·¯å®¹é‡ï¼›å¯ä»¥å®ç°ä¸åŒé“¾è·¯ä¹‹é—´ä¸åŒæ•°æ®ç‡çš„è½¬æ¢ï¼›å¯ä»¥å®ç°æ ¼å¼è½¬æ¢ï¼›å¯ä»¥å®ç°ä¸€å¯¹å¤šã€å¤šå¯¹ä¸€çš„è®¿é—´ï¼›å¯ä»¥å®ç°å·®é”™æ§åˆ¶ã€‚å…¶ç¼ºç‚¹æ˜¯å¢åŠ äº†èµ„æºå¼€é”€ï¼ˆå¦‚è¾…åŠ©ä¿¡æ¯å¯¼è‡´å¤„ç†æ—¶é—´å’Œå­˜å‚¨èµ„æºçš„å¼€é”€ï¼‰ï¼šå¢åŠ ç¼“å†²å»¶è¿Ÿï¼›é¢å¤–çš„æ§åˆ¶æœºåˆ¶æ¥ä¿è¯å¤šä¸ªæŠ¥æ–‡çš„é¡ºåºä¸ä¼šä¹±åºï¼›ç¼“å†²åŒºéš¾ä»¥ç®¡ç†ï¼Œå› ä¸ºæŠ¥æ–‡çš„å¤§å°ä¸ç¡®å®šï¼Œæ¥æ”¶æ–¹åœ¨æ¥æ”¶åˆ°æŠ¥æ–‡ä¹‹å‰ä¸èƒ½é¢„çŸ¥æŠ¥æ–‡çš„å¤§å°ã€‚</p>
</li>
<li><p>åˆ†ç»„äº¤æ¢<br>åˆ†ç»„äº¤æ¢ç½‘ç»œï¼Œä¹Ÿç§°ä¸ºåŒ…äº¤æ¢ç½‘ç»œã€‚å…¶åŸç†æ˜¯å°†ç”¨æˆ·æ•°æ®åˆ†æˆè¾ƒçŸ­çš„å›ºå®šé•¿åº¦çš„æ•°æ®å—ï¼Œåœ¨æ¯ä¸ªæ•°æ®å—ä¸­åŠ ä¸Šç›®çš„åœ°å€ã€æºåœ°å€ç­‰è¾…åŠ©ä¿¡æ¯ç»„æˆåˆ†ç»„ï¼ˆåŒ…ï¼‰ï¼Œä»¥å­˜å‚¨-è½¬å‘æ–¹å¼ä¼ è¾“ã€‚</p>
<p>é™¤äº†å…·å¤‡æŠ¥æ–‡äº¤æ¢ç½‘ç»œçš„ä¼˜ç‚¹å¤–ï¼Œåˆ†ç»„äº¤æ¢ç½‘ç»œè¿˜å…·æœ‰è‡ªèº«çš„ä¼˜ç‚¹ï¼šç¼“å†²æ˜“äºç®¡ç†ï¼›åŒ…çš„å¹³å‡å»¶è¿Ÿæ›´å°ï¼Œç½‘ç»œä¸­å ç”¨çš„å¹³å‡ç¼“å†²åŒºæ›´å°‘ï¼›æ›´æ˜“äºæ ‡å‡†åŒ–ï¼›æ›´é€‚åˆåº”ç”¨ã€‚</p>
</li>
</ol>
<p>ç°åœ¨çš„ä¸»æµç½‘ç»œåŸºæœ¬ä¸Šéƒ½å¯ä»¥çœ‹æˆæ˜¯<strong>åˆ†ç»„äº¤æ¢</strong>ç½‘ç»œã€‚</p>
<h2 id="ç«¯åˆ°ç«¯çš„é€šä¿¡å’Œç‚¹åˆ°ç‚¹çš„é€šä¿¡çš„åŒºåˆ«ï¼Ÿ"><a href="#ç«¯åˆ°ç«¯çš„é€šä¿¡å’Œç‚¹åˆ°ç‚¹çš„é€šä¿¡çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="ç«¯åˆ°ç«¯çš„é€šä¿¡å’Œç‚¹åˆ°ç‚¹çš„é€šä¿¡çš„åŒºåˆ«ï¼Ÿ"></a>ç«¯åˆ°ç«¯çš„é€šä¿¡å’Œç‚¹åˆ°ç‚¹çš„é€šä¿¡çš„åŒºåˆ«ï¼Ÿ</h2><p> ä¸‰ç‚¹ä¸åŒï¼š</p>
<ul>
<li>å®ä½“ä¸åŒ</li>
<li>å‘ç”Ÿçš„å±‚ä¸åŒ</li>
<li>ç‚¹åˆ°ç‚¹ä¸æ”¯æŒå¯é ä¼ è¾“ï¼Œè€Œç«¯åˆ°ç«¯æ”¯æŒ</li>
</ul>
<p>ä»æœ¬è´¨ä¸Šè¯´ï¼Œç”±ç‰©ç†å±‚ã€æ•°æ®é“¾è·¯å±‚å’Œç½‘ç»œå±‚ç»„æˆçš„é€šä¿¡å­ç½‘ä¸ºç½‘ç»œç¯å¢ƒä¸­çš„ä¸»æœºæä¾›ç‚¹åˆ°ç‚¹çš„æœåŠ¡ï¼Œè€Œä¼ è¾“å±‚ä¸ºç½‘ç»œä¸­çš„ä¸»æœºæä¾›ç«¯åˆ°ç«¯çš„é€šä¿¡ã€‚</p>
<p>ç›´æ¥ç›¸è¿çš„ç»“ç‚¹ä¹‹é—´çš„é€šä¿¡å«ç‚¹åˆ°ç‚¹é€šä¿¡ã€‚å®ƒåªæä»¶ä¸€åˆå´ç¥¨åˆ°å¦ä¸€å°æœºå™¨ä¹‹é—´çš„é€šä¿¡ï¼Œä¸ä¼šæ¶‰åŠç¨‹åºæˆ–è¿›ç¨‹çš„æ¦‚å¿µã€‚åŒæ—¶ç‚¹åˆ°ç‚¹é€šä¿¡å¹¶ä¸èƒ½ä¿è¯æ•°æ®ä¼ è¾“çš„å¯é æ€§ï¼Œä¹Ÿä¸èƒ½è¯´æ˜æºä¸»æœºä¸ç›®çš„ä¸»æœºä¹‹é—´æ˜¯å“ªä¸¤ä¸ªè¿›ç¨‹åœ¨é€šä¿¡ï¼Œè¿™äº›å·¥ä½œéƒ½æ˜¯ç”±ä¼ è¾“å±‚æ¥å®Œæˆçš„ã€‚</p>
<p>ç«¯åˆ°ç«¯é€šä¿¡å»ºç«‹åœ¨ç‚¹åˆ°ç‚¹é€šä¿¡çš„åŸºç¡€ä¸Šï¼Œå®ƒæ˜¯ç”±ä¸€æ®µæ®µçš„ç‚¹åˆ°ç‚¹é€šä¿¡ä¿¡é“æ„æˆçš„ï¼Œæ˜¯æ¯”ç‚¹åˆ°ç‚¹é€šä¿¡æ›´é«˜ä¸€çº§çš„é€šä¿¡æ–¹å¼ï¼Œä»¥å®Œæˆåº”ç”¨ç¨‹åºï¼ˆè¿›ç¨‹ï¼‰ä¹‹é—´çš„é€šä¿¡ã€‚â€œç«¯â€æ˜¯æŒ‡ç”¨æˆ·ç¨‹åºçš„ç«¯å£ï¼Œç«¯å£å·æ ‡è¯†äº†åº”ç”¨å±‚ä¸­ä¸åŒçš„è¿›ç¨‹ã€‚</p>
<h2 id="é€šä¿¡æ–¹å¼"><a href="#é€šä¿¡æ–¹å¼" class="headerlink" title="é€šä¿¡æ–¹å¼"></a>é€šä¿¡æ–¹å¼</h2><h3 id="å•å·¥é€šä¿¡"><a href="#å•å·¥é€šä¿¡" class="headerlink" title="å•å·¥é€šä¿¡"></a>å•å·¥é€šä¿¡</h3><p>åªèƒ½æœ‰ä¸€ä¸ªæ–¹å‘çš„é€šä¿¡ï¼Œæ²¡æœ‰åæ–¹å‘çš„äº¤äº’ï¼Œåªéœ€è¦ä¸€ä¸ªä¿¡é“ã€‚</p>
<h3 id="åŠåŒå·¥"><a href="#åŠåŒå·¥" class="headerlink" title="åŠåŒå·¥"></a>åŠåŒå·¥</h3><p>é€šä¿¡çš„åŒæ–¹éƒ½å¯ä»¥å‘é€æˆ–è€…æ¥å—æ¶ˆæ¯ï¼Œä½†æ˜¯ä»»ä½•ä¸€æ–¹ä¸èƒ½åŒæ—¶å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼Œéœ€è¦ä¸¤ä¸ªä¿¡é“ã€‚</p>
<h3 id="å…¨åŒå·¥"><a href="#å…¨åŒå·¥" class="headerlink" title="å…¨åŒå·¥"></a>å…¨åŒå·¥</h3><p>é€šä¿¡çš„åŒæ–¹éƒ½å¯ä»¥åŒæ—¶å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼Œéœ€è¦ä¸¤ä¸ªä¿¡é“ã€‚</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ibitm.github.io/2019/12/14/2019%20%E5%B9%B4%E5%B9%B4%E5%BA%95%EF%BC%8C%E5%85%B3%E4%BA%8E%E9%9D%A2%E8%AF%95%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93%E5%92%8C%E4%B8%AA%E4%BA%BA%E5%8F%91%E5%B1%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20191124213944.png">
      <meta itemprop="name" content="å¼ æ½‡">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±‚ç´¢ä¹‹å¿ƒ">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/14/2019%20%E5%B9%B4%E5%B9%B4%E5%BA%95%EF%BC%8C%E5%85%B3%E4%BA%8E%E9%9D%A2%E8%AF%95%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93%E5%92%8C%E4%B8%AA%E4%BA%BA%E5%8F%91%E5%B1%95/" class="post-title-link" itemprop="url">2019 å¹´å¹´åº•ï¼Œå…³äºé¢è¯•çš„ä¸€äº›æ€»ç»“</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-14 09:53:36" itemprop="dateCreated datePublished" datetime="2019-12-14T09:53:36+08:00">2019-12-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9A%8F%E7%AC%94/" itemprop="url" rel="index">
                    <span itemprop="name">éšç¬”</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2019/12/14/2019%20%E5%B9%B4%E5%B9%B4%E5%BA%95%EF%BC%8C%E5%85%B3%E4%BA%8E%E9%9D%A2%E8%AF%95%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93%E5%92%8C%E4%B8%AA%E4%BA%BA%E5%8F%91%E5%B1%95/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/12/14/2019%20%E5%B9%B4%E5%B9%B4%E5%BA%95%EF%BC%8C%E5%85%B3%E4%BA%8E%E9%9D%A2%E8%AF%95%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93%E5%92%8C%E4%B8%AA%E4%BA%BA%E5%8F%91%E5%B1%95/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>è¿™ä¸€å‘¨é¢è¯•äº†è…¾è®¯å’Œç™¾åº¦çš„ã€Œæ•°æ®å¼€å‘ã€å²—ï¼Œå¯¹è¿™ä¸ªå²—ä½æœ‰äº†æ›´åŠ æ¸…æ¥šçš„è®¤è¯†å’Œå®šä½ï¼Œæ•°æ®å¼€å‘å²—å°±æ˜¯ä¸ºå¤§æ•°æ®çš„å…¨ç”Ÿå‘½å‘¨æœŸæä¾›æœåŠ¡ï¼ŒåŒ…æ‹¬æ•°æ®äº§ç”Ÿï¼Œä¼ è¾“ï¼Œå»ºæ¨¡ï¼Œç»Ÿè®¡</p>
<p>åˆ†æï¼Œå®éªŒè¯„ä¼°ï¼Œå¯è§†åŒ–çš„å…¨æµç¨‹ã€‚</p>
<p>è´Ÿè´£çš„å·¥ä½œä¸»è¦åŒ…æ‹¬ï¼š</p>
<ul>
<li><p>å‰æœŸçš„å·¥ä½œä¸»è¦å°±æ˜¯ ETLï¼Œå°†æ•°æ®ä»æ¥æºç«¯ç»è¿‡æŠ½å–ï¼ˆextractï¼‰ã€è½¬æ¢ï¼ˆtransformï¼‰ã€åŠ è½½ï¼ˆloadï¼‰åˆ°æ•°æ®åº“ä¸­çš„è¿‡ç¨‹ã€‚</p>
<p>è¿™éƒ¨åˆ†å¯èƒ½éœ€è¦æŒæ¡ä¸€äº›æ•°æ®åº“çš„åŸºæœ¬ç†è®ºã€SQL ä»¥åŠå¤§æ•°æ®ç»„ä»¶çš„ä½¿ç”¨å’Œè°ƒä¼˜ï¼Œæ¯”å¦‚ Hadoopï¼ŒHiveå’ŒHBaseï¼Œå¾ˆå°‘ä¼šæ¶‰åŠç»„ä»¶çš„å¤§è§„æ¨¡äºŒæ¬¡å¼€å‘</p>
</li>
<li><p>ä¸­æœŸå·¥ä½œå°±æ˜¯æ•°æ®åˆ†æï¼Œé€šè¿‡ä¸Šä¸€ä¸ªè¿‡ç¨‹è·å¾—çš„æ•°æ®ï¼Œå¼€å§‹å»ºæ¨¡åˆ†æï¼Œä»¥è¾¾åˆ°ä¸€å®šçš„ç›®çš„ã€‚</p>
<p>è¿™éƒ¨åˆ†é€šå¸¸æ˜¯ä½¿ç”¨æœºå™¨å­¦ä¹ ç®—æ³•ï¼ˆä½†ä¸é™äºæœºå™¨å­¦ä¹ ç®—æ³•ï¼‰æ¥è¾¾åˆ°å»ºæ¨¡åˆ†æçš„ç›®çš„ã€‚</p>
<p>è¿™éƒ¨åˆ†å·¥ä½œå’Œæ•°å­¦å»ºæ¨¡ä¸­çš„ã€Œæ•°æ®é¢˜ã€çš„è§£ç­”è¿‡ç¨‹å¾ˆåƒã€‚</p>
</li>
<li><p>ç»“æœå±•ç¤º</p>
<p>ä¸€èˆ¬å°±æ˜¯æŒ‡ BI æŠ¥è¡¨ã€å¯è§†åŒ–æˆ–è€…å¯è¡Œæ€§åˆ†æã€‚</p>
</li>
</ul>
<p>å› ä¸ºä¸åŒéƒ¨é—¨å¯¹äºæ•°æ®å¼€å‘çš„å®šä¹‰å’Œè´Ÿè´£çš„å·¥ä½œä¸å¤ªä¸€æ ·ï¼Œæˆ‘æ ¹æ®æˆ‘çš„è®¤è¯†å°†æ•°æ®å¼€å‘å²—å’Œå…¶ä»–çš„å²—ä½è¿›è¡Œä¸€ä¸‹å¯¹æ¯”</p>
<p><strong>ç®—æ³•å·¥ç¨‹å¸ˆ</strong></p>
<blockquote>
<p>æ•°æ®å¼€å‘æˆ–è€…è¯´æ•°æ®åˆ†æå²—ä½å’Œç®—æ³•å²—æœ‰ç›¸ä¼¼çš„åœ°æ–¹ï¼Œä¹Ÿæœ‰ä¸åŒçš„åœ°æ–¹</p>
<p>ä¸¤è€…éƒ½éœ€è¦ä½¿ç”¨æœºå™¨å­¦ä¹ ç®—æ³•å¯¹æ•°æ®è¿›è¡Œå»ºæ¨¡åˆ†æï¼Œä½†æ˜¯ç®—æ³•å·¥ç¨‹å¸ˆä¸­ç®—æ³•çš„ä½¿ç”¨ä¼šç›´æ¥ä¸Šçº¿ï¼Œä½œç”¨åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ã€‚è€Œæ•°æ®åˆ†æçš„ç®—æ³•æ˜¯åœ¨ç¦»çº¿ç¯å¢ƒä¸‹è¿›è¡Œçš„ï¼Œæ˜¯ä¸ºäº†åˆ†æä¸šåŠ¡ç»“æœè€Œè¿›è¡Œã€‚</p>
<p>ä¸¾ä¸€ä¸ªä¸æ°å½“çš„ä¾‹å­ï¼Œæ‹¿æŸæ–°é—» APP ä¸¾ä¾‹ï¼Œæ–°é—»ç»„çš„æ¨èç®—æ³•æ˜¯ç›´æ¥ä½œç”¨åˆ°ä¸šåŠ¡ä¸Šçš„ï¼Œä¼šå†³å®šä½ æ¨èçš„ç»“æœï¼Œè€Œæ•°æ®åˆ†æè´Ÿè´£çš„å·¥ä½œæ˜¯å½“æ–°é—» APP çš„ç”¨æˆ·æ—¥ä½¿ç”¨é‡å‡ºç°ä¸‹é™æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ç®—æ³•æ¥åˆ†æä¸ºä»€ä¹ˆä¼šå‡ºç°ç”¨æˆ·æ—¥ä½¿ç”¨é‡çš„ä¸‹é™ã€‚æ•°æ®åˆ†æå¸ˆçš„ç®—æ³•å¹¶ä¸ä¼šç›´æ¥ä½œç”¨åˆ°ä¸šåŠ¡ï¼Œè€Œæ˜¯æŒ–æ˜æ•°æ®ä¸­çš„ä¿¡æ¯ï¼Œä¸ºäº†ç†è§£ä¸šåŠ¡è€Œè¿›è¡Œçš„ã€‚</p>
<p>å¹¶ä¸”æŠ€æœ¯æ ˆä¹Ÿä¼šæœ‰æ˜æ˜¾ä¸åŒï¼Œæ•°æ®å¼€å‘å¯¹äºå¤§æ•°æ®ç»„ä»¶çš„ä½¿ç”¨å’Œè°ƒä¼˜ã€ä»¥åŠSQLçš„ä½¿ç”¨è¦æ±‚æ›´é«˜ï¼Œè€Œç®—æ³•å·¥ç¨‹å¸ˆåˆ™æ˜¯ç®—æ³•çš„è®¾è®¡ã€å®ç°ã€è°ƒå‚æœ‰æ›´é«˜çš„è¦æ±‚ï¼Œä¸»è¦æ˜¯å¯¹äºç¼–ç¨‹èƒ½åŠ›å’Œæ•°å­¦åŠŸåº•çš„è¦æ±‚ã€‚</p>
</blockquote>
<p><strong>æ•°æ®ä»“åº“å·¥ç¨‹å¸ˆ</strong></p>
<blockquote>
<p>æ•°æ®ä»“åº“å²—ä¸æ•°æ®å¼€å‘å²—çš„å…³ç³»æ›´åƒæ˜¯æ•°æ®å¼€å‘çš„è¿›é˜¶ç‰ˆã€‚æ•°æ®ä»“åº“å¼€å‘äººå‘˜è¿˜è¦å‚ä¸æ•°æ®ä»“åº“ ETL æµç¨‹è®¾è®¡ã€å¼€å‘å’Œä¼˜åŒ–ï¼Œè§£å†³ ETL è¿‡ç¨‹ç›¸å…³æŠ€æœ¯é—®é¢˜</p>
<p>è¿™å°±åœ¨æ•°æ®å¼€å‘å²—çš„è¦æ±‚ä¹‹ä¸Šï¼Œè¦æ±‚æ•°æ®ä»“åº“å¼€å‘äººå‘˜ç†Ÿæ‚‰æ•°æ®ä»“åº“å„ç±»æ¨¡å‹å»ºæ¨¡ç†è®ºï¼Œäº†è§£æ•°æ®ä»“åº“æ•°æ®åˆ†å±‚æ¶æ„ï¼Œå¤šç»´æ•°æ®æ¨¡å‹è®¾è®¡ï¼Œç†è®ºæ€§æ›´å¼ºä¸€äº›ã€‚</p>
</blockquote>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ibitm.github.io/2019/12/12/ConcurrentHashMap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20191124213944.png">
      <meta itemprop="name" content="å¼ æ½‡">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±‚ç´¢ä¹‹å¿ƒ">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/12/ConcurrentHashMap/" class="post-title-link" itemprop="url">ConcurrentHashMap</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-12 16:30:15" itemprop="dateCreated datePublished" datetime="2019-12-12T16:30:15+08:00">2019-12-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2019/12/12/ConcurrentHashMap/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/12/12/ConcurrentHashMap/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="JDK-7"><a href="#JDK-7" class="headerlink" title="JDK 7"></a>JDK 7</h2><h3 id="å­˜å‚¨ç»“æ„"><a href="#å­˜å‚¨ç»“æ„" class="headerlink" title="å­˜å‚¨ç»“æ„"></a>å­˜å‚¨ç»“æ„</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HashEntry</span><<span class="title">K</span>,<span class="title">V</span>> </span>{</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    <span class="keyword">volatile</span> V value;</span><br><span class="line">    <span class="keyword">volatile</span> HashEntry<K,V> next;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ConcurrentHashMap å’Œ HashMap å®ç°ä¸Šç±»ä¼¼ï¼Œæœ€ä¸»è¦çš„å·®åˆ«æ˜¯ ConcurrentHashMapå¼•å…¥äº†ä¸€ä¸ªåˆ†æ®µçš„æ¦‚å¿µï¼ˆSegmentï¼‰ï¼Œæ¯ä¸ªåˆ†æ®µé”ç»´æŠ¤ç€å‡ ä¸ªæ¡¶ï¼ˆHashEntryï¼‰ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è®¿é—®ä¸åŒåˆ†æ®µé”ä¸Šçš„æ¡¶ï¼Œä»è€Œä½¿å…¶å¹¶å‘åº¦æ›´é«˜ï¼ˆå¹¶å‘åº¦å°±æ˜¯ Segment çš„ä¸ªæ•°ï¼‰</p>
<p>Segment ç»§æ‰¿è‡ª ReentrantLockã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Segment</span><<span class="title">K</span>,<span class="title">V</span>> <span class="keyword">extends</span> <span class="title">ReentrantLock</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">2249069246763182397L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_SCAN_RETRIES =</span><br><span class="line">        Runtime.getRuntime().availableProcessors() > <span class="number">1</span> ? <span class="number">64</span> : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">transient</span> <span class="keyword">volatile</span> HashEntry<K,V>[] table;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">transient</span> <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">transient</span> <span class="keyword">int</span> modCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">transient</span> <span class="keyword">int</span> threshold;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">float</span> loadFactor;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Segment<K,V>[] segments;</span><br></pre></td></tr></tbody></table></figure>
<p>é»˜è®¤çš„å¹¶å‘çº§åˆ«ä¸º 16ï¼Œä¹Ÿå°±æ˜¯è¯´é»˜è®¤åˆ›å»º 16 ä¸ª Segmentã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CONCURRENCY_LEVEL = <span class="number">16</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ä»ä¸Šé¢çš„ç»“æ„æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼ŒConcurrentHashMap å®šä½ä¸€ä¸ªå…ƒç´ çš„è¿‡ç¨‹éœ€è¦è¿›è¡Œä¸¤æ¬¡ Hash æ“ä½œã€‚</p>
<p>ç¬¬ä¸€æ¬¡Hashå®šä½åˆ°Segmentï¼Œç¬¬äºŒæ¬¡Hashå®šä½åˆ°å…ƒç´ æ‰€åœ¨çš„é“¾è¡¨çš„å¤´éƒ¨ã€‚</p>
<p><strong>åå¤„</strong></p>
<p>è¿™ä¸€ç§ç»“æ„çš„å¸¦æ¥çš„å‰¯ä½œç”¨æ˜¯Hashçš„è¿‡ç¨‹è¦æ¯”æ™®é€šçš„HashMapè¦é•¿</p>
<p><strong>å¥½å¤„</strong></p>
<p>å†™æ“ä½œçš„æ—¶å€™å¯ä»¥åªå¯¹å…ƒç´ æ‰€åœ¨çš„Segmentè¿›è¡ŒåŠ é”å³å¯ï¼Œä¸ä¼šå½±å“åˆ°å…¶ä»–çš„Segmentï¼Œè¿™æ ·ï¼Œåœ¨æœ€ç†æƒ³çš„æƒ…å†µä¸‹ï¼ŒConcurrentHashMapå¯ä»¥æœ€é«˜åŒæ—¶æ”¯æŒSegmentæ•°é‡å¤§å°çš„å†™æ“ä½œï¼ˆåˆšå¥½è¿™äº›å†™æ“ä½œéƒ½éå¸¸å¹³å‡åœ°åˆ†å¸ƒåœ¨æ‰€æœ‰çš„Segmentä¸Šï¼‰ã€‚</p>
<p>æ‰€ä»¥ï¼Œé€šè¿‡è¿™ä¸€ç§ç»“æ„ï¼ŒConcurrentHashMapçš„å¹¶å‘èƒ½åŠ›å¯ä»¥å¤§å¤§çš„æé«˜ã€‚</p>
<h3 id="Sizeæ–¹æ³•"><a href="#Sizeæ–¹æ³•" class="headerlink" title="Sizeæ–¹æ³•"></a>Sizeæ–¹æ³•</h3><p>æ¯ä¸ª Segment ç»´æŠ¤äº†ä¸€ä¸ª count å˜é‡æ¥ç»Ÿè®¡è¯¥ Segment ä¸­çš„é”®å€¼å¯¹ä¸ªæ•°ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The number of elements. Accessed only either within locks</span></span><br><span class="line"><span class="comment"> * or among other volatile reads that maintain visibility.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> count;</span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨æ‰§è¡Œ size æ“ä½œæ—¶ï¼Œéœ€è¦éå†æ‰€æœ‰ Segment ç„¶åæŠŠ count ç´¯è®¡èµ·æ¥ã€‚</p>
<p>ConcurrentHashMap åœ¨æ‰§è¡Œ size æ“ä½œæ—¶å…ˆå°è¯•ä¸åŠ é”ï¼Œå¦‚æœè¿ç»­ä¸¤æ¬¡ä¸åŠ é”æ“ä½œå¾—åˆ°çš„ç»“æœä¸€è‡´ï¼Œé‚£ä¹ˆå¯ä»¥è®¤ä¸ºè¿™ä¸ªç»“æœæ˜¯æ­£ç¡®çš„ã€‚</p>
<p>å°è¯•æ¬¡æ•°ä½¿ç”¨ RETRIES_BEFORE_LOCK å®šä¹‰ï¼Œè¯¥å€¼ä¸º 2ï¼Œretries åˆå§‹å€¼ä¸º -1ï¼Œå› æ­¤å°è¯•æ¬¡æ•°ä¸º 3ã€‚</p>
<p>å¦‚æœå°è¯•çš„æ¬¡æ•°è¶…è¿‡ 3 æ¬¡ï¼Œå°±éœ€è¦å¯¹æ¯ä¸ª Segment åŠ é”ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Number of unsynchronized retries in size and containsValue</span></span><br><span class="line"><span class="comment"> * methods before resorting to locking. This is used to avoid</span></span><br><span class="line"><span class="comment"> * unbounded retries if tables undergo continuous modification</span></span><br><span class="line"><span class="comment"> * which would make it impossible to obtain an accurate result.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RETRIES_BEFORE_LOCK = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// Try a few times to get accurate count. On failure due to</span></span><br><span class="line">    <span class="comment">// continuous async changes in table, resort to locking.</span></span><br><span class="line">    <span class="keyword">final</span> Segment<K,V>[] segments = <span class="keyword">this</span>.segments;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">boolean</span> overflow; <span class="comment">// true if size overflows 32 bits</span></span><br><span class="line">    <span class="keyword">long</span> sum;         <span class="comment">// sum of modCounts</span></span><br><span class="line">    <span class="keyword">long</span> last = <span class="number">0L</span>;   <span class="comment">// previous sum</span></span><br><span class="line">    <span class="keyword">int</span> retries = -<span class="number">1</span>; <span class="comment">// first iteration isn't retry</span></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">for</span> (;;) {</span><br><span class="line">            <span class="comment">// è¶…è¿‡å°è¯•æ¬¡æ•°ï¼Œåˆ™å¯¹æ¯ä¸ª Segment åŠ é”</span></span><br><span class="line">            <span class="keyword">if</span> (retries++ == RETRIES_BEFORE_LOCK) {</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j < segments.length; ++j)</span><br><span class="line">                    ensureSegment(j).lock(); <span class="comment">// force creation</span></span><br><span class="line">            }</span><br><span class="line">            sum = <span class="number">0L</span>;</span><br><span class="line">            size = <span class="number">0</span>;</span><br><span class="line">            overflow = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j < segments.length; ++j) {</span><br><span class="line">                Segment<K,V> seg = segmentAt(segments, j);</span><br><span class="line">                <span class="keyword">if</span> (seg != <span class="keyword">null</span>) {</span><br><span class="line">                    sum += seg.modCount;</span><br><span class="line">                    <span class="keyword">int</span> c = seg.count;</span><br><span class="line">                    <span class="keyword">if</span> (c < <span class="number">0</span> || (size += c) < <span class="number">0</span>)</span><br><span class="line">                        overflow = <span class="keyword">true</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// è¿ç»­ä¸¤æ¬¡å¾—åˆ°çš„ç»“æœä¸€è‡´ï¼Œåˆ™è®¤ä¸ºè¿™ä¸ªç»“æœæ˜¯æ­£ç¡®çš„</span></span><br><span class="line">            <span class="keyword">if</span> (sum == last)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            last = sum;</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        <span class="keyword">if</span> (retries > RETRIES_BEFORE_LOCK) {</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j < segments.length; ++j)</span><br><span class="line">                segmentAt(segments, j).unlock();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> overflow ? Integer.MAX_VALUE : size;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="äºŒã€JDK-8"><a href="#äºŒã€JDK-8" class="headerlink" title="äºŒã€JDK 8"></a>äºŒã€JDK 8</h2><p>JDK8 ä¸­å½»åº•æ”¾å¼ƒäº† Segment è½¬è€Œé‡‡ç”¨çš„æ˜¯ Node ï¼Œå…¶è®¾è®¡æ€æƒ³ä¹Ÿä¸å†æ˜¯ JDK7 ä¸­çš„åˆ†æ®µé”æ€æƒ³ã€‚</p>
<p>åœ¨ JDK8 ä¸­ ConcurrentHashMap åˆ©ç”¨ CAS + Synchronized æ¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œå®ƒçš„åº•å±‚æ•°æ®ç»“æ„ä¾ç„¶æ˜¯æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘ã€‚</p>
<h3 id="é‡è¦å±æ€§"><a href="#é‡è¦å±æ€§" class="headerlink" title="é‡è¦å±æ€§"></a>é‡è¦å±æ€§</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConcurrentHashMapæ ¸å¿ƒæ•°ç»„</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Node<K,V>[] table;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CAPACITY = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰©å®¹æ—¶æ‰ä¼šç”¨çš„ä¸€ä¸ªä¸´æ—¶æ•°ç»„</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node<K,V>[] nextTable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¡¨åˆå§‹åŒ–å’Œå¤§å°è°ƒæ•´æ§ä»¶</span></span><br><span class="line"><span class="comment"> * -1 è¡¨ç¤ºæ­£åœ¨åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"> * -n è¡¨ç¤ºæœ‰n-1çš„çº¿ç¨‹æ­£åœ¨æ‰©å®¹.  </span></span><br><span class="line"><span class="comment"> * å½“ table ä¸ºç©ºæ—¶, ç”¨æ¥å­˜å‚¨è¦åˆå§‹åŒ–çš„è¡¨çš„å€¼çš„å¤§å°</span></span><br><span class="line"><span class="comment"> * å½“ table å·²ç»åˆå§‹åŒ–ä»¥åï¼Œè¡¨ç¤ºç”¨æ¥è°ƒæ•´è¡¨å¤§å°çš„å€¼</span></span><br><span class="line"><span class="comment"> * æ€»ä¹‹ï¼ŒsizeCtl ä¸ºæ­£å’Œä¸ºè´Ÿè¡¨ç¤ºæˆªç„¶ä¸åŒçš„æ¦‚å¿µ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> sizeCtl;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resizeçš„æ—¶å€™ä¸‹ä¸€ä¸ªéœ€è¦å¤„ç†çš„å…ƒç´ ä¸‹æ ‡ä¸ºindex=transferIndex-1</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> transferIndex;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡CASæ— é”æ›´æ–°ï¼ŒConcurrentHashMapå…ƒç´ æ€»æ•°ï¼Œä½†ä¸æ˜¯å‡†ç¡®å€¼</span></span><br><span class="line"><span class="comment">// å› ä¸ºå¤šä¸ªçº¿ç¨‹åŒæ—¶æ›´æ–°ä¼šå¯¼è‡´éƒ¨åˆ†çº¿ç¨‹æ›´æ–°å¤±è´¥ï¼Œå¤±è´¥æ—¶ä¼šå°†å…ƒç´ æ•°ç›®å˜åŒ–å­˜å‚¨åœ¨counterCellsä¸­</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">long</span> baseCount;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resizeæˆ–è€…åˆ›å»ºCounterCellsæ—¶çš„ä¸€ä¸ªæ ‡å¿—ä½</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> cellsBusy;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºå­˜å‚¨å…ƒç´ å˜åŠ¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> CounterCell[] counterCells;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="é‡è¦æ–¹æ³•"><a href="#é‡è¦æ–¹æ³•" class="headerlink" title="é‡è¦æ–¹æ³•"></a>é‡è¦æ–¹æ³•</h3><h4 id="Unsafe-compareAndSwapXXX-æ–¹æ³•"><a href="#Unsafe-compareAndSwapXXX-æ–¹æ³•" class="headerlink" title="Unsafe.compareAndSwapXXX æ–¹æ³•"></a>Unsafe.compareAndSwapXXX æ–¹æ³•</h4><p><code>Unsafe.compareAndSwapXXX()</code> æ–¹æ³•æ˜¯ sun.misc.Unsafe ç±»ä¸­çš„æ–¹æ³•ï¼Œå› ä¸ºåœ¨ ConcurrentHashMap ä¸­å¤§é‡ä½¿ç”¨äº†è¿™äº›æ–¹æ³•ã€‚å…¶å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">compareAndSwapXXX</span><span class="params">(type1 object, type2 offset, type4 expect, type5 update)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<p>æ–¹æ³•çš„ä¼ªé€»è¾‘å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (object[offset].value equal expect) {</span><br><span class="line">    object[offset].value = update;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">} <span class="keyword">else</span> </span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">false</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>CASæ–¹æ³•éƒ½æ˜¯nativeæ–¹æ³•ï¼Œå¯ä»¥ä¿è¯åŸå­æ€§ï¼Œå¹¶ä¸”æ•ˆç‡æ¯”synchronizedé«˜ã€‚ </p>
<p>å…³äºCASæ–¹æ³•çš„åŸç†ï¼Œå»ºè®®å‚è€ƒä¸€ä¸‹ä¸¤ç¯‡åšå®¢ï¼Œå¼ºçƒˆæ¨è</p>
<p><a href="http://www.dataguru.cn/java-865024-1-1.html" target="_blank" rel="noopener">http://www.dataguru.cn/java-865024-1-1.html</a></p>
<p><a href="https://www.cnblogs.com/Mainz/p/3546347.html" target="_blank" rel="noopener">https://www.cnblogs.com/Mainz/p/3546347.html</a></p>
<h4 id="hashæ–¹æ³•"><a href="#hashæ–¹æ³•" class="headerlink" title="hashæ–¹æ³•"></a>hashæ–¹æ³•</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HASH_BITS = <span class="number">0x7fffffff</span>; <span class="comment">// usable bits of normal node hash</span></span><br><span class="line"><span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">spread</span><span class="params">(<span class="keyword">int</span> h)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (h ^ (h >>> <span class="number">16</span>)) & HASH_BITS;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>h ^ (h >>> 16) åœ¨è®¡ç®— hash çš„æ—¶å€™ key.hashCode() çš„é«˜ä½ä¹Ÿå‚ä¸è¿ç®—ï¼Œè¿™éƒ¨åˆ†è·Ÿ HashMap è®¡ç®—æ–¹æ³•ä¸€è‡´ï¼Œä¸åŒçš„æ˜¯ h ^ (h >>> 16) è®¡ç®—ç»“æœ & ä¸Š 0x7fffffff ï¼Œä»è€Œä¿è¯ç»“æœä¸€å®šä¸ºæ­£æ•´æ•°ã€‚è·å¾— hash ä¹‹åï¼Œé€šè¿‡hash & (n -1)è®¡ç®—ä¸‹æ ‡ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¦å¤šæ·»åŠ ä¸€ä¸ªä¸æ“ä½œå‘¢ï¼Œçœ‹åé¢çš„æ³¨é‡Š</p>
<blockquote>
<p>usable bits of normal node hash</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MOVED     = -<span class="number">1</span>; <span class="comment">// hash for forwarding nodes</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEBIN   = -<span class="number">2</span>; <span class="comment">// hash for roots of trees</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESERVED  = -<span class="number">3</span>; <span class="comment">// hash for transient reservations</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HASH_BITS = <span class="number">0x7fffffff</span>; <span class="comment">// usable bits of normal node hash</span></span><br></pre></td></tr></tbody></table></figure>
<p>ConcurrentHashMap ä¸­çš„å…ƒç´ èŠ‚ç‚¹æ€»ç»“ä¸€ä¸‹æœ‰è¿™ä¹ˆå‡ ç§å¯èƒ½ï¼š</p>
<ul>
<li><p>null </p>
</li>
<li><p>Node<k, v> æ™®é€šèŠ‚ç‚¹ï¼Œå¯ä»¥ç»„æˆå•å‘é“¾è¡¨ï¼Œhash > 0</k,></p>
</li>
<li><p>TreeBin<k,v> çº¢é»‘æ ‘èŠ‚ç‚¹ï¼ŒTreeBin æ˜¯å¯¹ TreeNode çš„å°è£…ï¼Œå…¶ hash ä¸º TREEBIN = -2ã€‚</k,v></p>
<p>HashMap å’Œ ConcurrentHashMap çš„ TreeNode å®ç°å¹¶ä¸ç›¸åŒã€‚</p>
<p>åœ¨ HashMap ä¸­ TreeNode å°è£…äº†çº¢é»‘æ ‘æ‰€æœ‰çš„æ“ä½œæ–¹æ³•ï¼Œè€Œ ConcurrentHashMap ä¸­çº¢é»‘æ ‘æ“ä½œçš„æ–¹æ³•éƒ½å°è£…åœ¨ TreeBin ä¸­ï¼ŒTreeBin ç›¸å½“äºä¸€ä¸ªçº¢é»‘æ ‘å®¹å™¨ï¼Œå®¹å™¨ä¸­çš„çº¢é»‘æ ‘èŠ‚ç‚¹ä¸º TreeNode ã€‚</p>
<p>HashMap å¯ä»¥ç›´æ¥åœ¨ tab[i] å­˜å…¥ TreeNode ï¼Œè€Œ ConCurrentHashMap åªèƒ½åœ¨ tab[i] å­˜å…¥ TreeBin ã€‚</p>
</li>
<li><p>ForwardingNode<k,v> key å’Œ value éƒ½ä¸º null çš„ä¸€ä¸ªç‰¹æ®ŠèŠ‚ç‚¹ï¼Œç”¨äº resize æ“ä½œå¡«å……å·²ç»å®Œæˆè¿ç§»æ“ä½œçš„èŠ‚ç‚¹ã€‚FrowardingNode çš„hashåœ¨åˆå§‹åŒ–çš„æ—¶å€™è¢«ç½®æˆMOVED = -1</k,v></p>
<p>åœ¨ resize è¿‡ç¨‹ä¸­å½“å‘ç° tab[i] ä¸Šæ˜¯ ForwardingNode çš„æ—¶å€™ï¼ˆé€šè¿‡hashåˆ¤æ–­ï¼‰å°±å¯çŸ¥ tab[i] å·²ç»è¿ç§»å®Œäº†ï¼Œç›´æ¥è·³è¿‡è¯¥èŠ‚ç‚¹å»å¤„ç†å…¶å®ƒèŠ‚ç‚¹ã€‚</p>
<p>ConcurrentHashMapç¦æ­¢ node çš„ key æˆ– value ä¸º null æˆ–è®¸è·Ÿè¯¥èŠ‚ç‚¹çš„å­˜åœ¨ä¹Ÿæ˜¯æœ‰ä¸€å®šå…³ç³»çš„ã€‚</p>
</li>
<li><p>ReservationNode<k,v>åªåœ¨ compute å’Œ computeIfAbsent ä¸­ä½¿ç”¨ï¼Œå…¶hashä¸ºRESERVED = -3</k,v></p>
</li>
</ul>
<p>ä»ä¸Šé¢çš„æ€»ç»“å¯ä»¥çœ‹å‡ºæ™®é€šèŠ‚ç‚¹hashä¸ºæ­£æ•´æ•°æ˜¯æœ‰æ„ä¹‰çš„ï¼Œhash > 0æ˜¯åˆ¤æ–­è¯¥èŠ‚ç‚¹æ˜¯å¦ä¸ºé“¾è¡¨èŠ‚ç‚¹ï¼ˆæ™®é€šèŠ‚ç‚¹ï¼‰çš„ä¸€ä¸ªé‡è¦ä¾æ®ã€‚</p>
<h4 id="get-set-update-tab-i-æ–¹æ³•"><a href="#get-set-update-tab-i-æ–¹æ³•" class="headerlink" title="get/set/update tab[i] æ–¹æ³•"></a>get/set/update tab[i] æ–¹æ³•</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–tab[i]èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <K,V> <span class="function">Node<K,V> <span class="title">tabAt</span><span class="params">(Node<K,V>[] tab, <span class="keyword">int</span> i)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (Node<K,V>)U.getObjectVolatile(tab, ((<span class="keyword">long</span>)i << ASHIFT) + ABASE);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// compare and swap tab[i]ï¼ŒæœŸæœ›å€¼æ˜¯cï¼Œtab[i].value == c ? tab[i] = v : return false</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <K,V> <span class="function"><span class="keyword">boolean</span> <span class="title">casTabAt</span><span class="params">(Node<K,V>[] tab, <span class="keyword">int</span> i, Node<K,V> c, Node<K,V> v)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> U.compareAndSwapObject(tab, ((<span class="keyword">long</span>)i << ASHIFT) + ABASE, c, v);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®tab[i] = v</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <K,V> <span class="function"><span class="keyword">void</span> <span class="title">setTabAt</span><span class="params">(Node<K,V>[] tab, <span class="keyword">int</span> i, Node<K,V> v)</span> </span>{</span><br><span class="line">    U.putObjectVolatile(tab, ((<span class="keyword">long</span>)i << ASHIFT) + ABASE, v);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="size-æ–¹æ³•"><a href="#size-æ–¹æ³•" class="headerlink" title="size() æ–¹æ³•"></a>size() æ–¹æ³•</h4><p>ConcurrentHashMapä¸­baseCountç”¨äºä¿å­˜tabä¸­å…ƒç´ æ€»æ•°ï¼Œä½†æ˜¯å¹¶ä¸å‡†ç¡®ï¼Œå› ä¸ºå¤šçº¿ç¨‹åŒæ—¶å¢åˆ æ”¹ï¼Œä¼šå¯¼è‡´baseCountä¿®æ”¹å¤±è´¥ï¼Œæ­¤æ—¶ä¼šå°†å…ƒç´ å˜åŠ¨å­˜å‚¨äºcounterCellsæ•°ç»„å†…ã€‚</p>
<p>å½“éœ€è¦ç»Ÿè®¡å½“å‰çš„sizeçš„æ—¶å€™ï¼Œé™¤äº†è¦ç»Ÿè®¡baseCountä¹‹å¤–ï¼Œè¿˜éœ€è¦ç»Ÿè®¡counterCellsä¸­çš„å…ƒç´ å˜åŒ–ã€‚</p>
<p>å€¼å¾—ä¸€æçš„æ˜¯å³ä½¿å¦‚æ­¤ï¼Œç»Ÿè®¡å‡ºæ¥çš„ä¾æ—§ä¸æ˜¯å½“å‰tabä¸­å…ƒç´ çš„å‡†ç¡®å€¼ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ç»Ÿè®¡å‰åå¹¶ä¸èƒ½stop the worldæš‚åœçº¿ç¨‹æ“ä½œï¼Œå› æ­¤æ— æ³•ä¿è¯å‡†ç¡®æ€§ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">long</span> n = sumCount();</span><br><span class="line">    <span class="keyword">return</span> ((n < <span class="number">0L</span>) ? <span class="number">0</span> : (n > (<span class="keyword">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE : (<span class="keyword">int</span>)n);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">long</span> <span class="title">sumCount</span><span class="params">()</span> </span>{</span><br><span class="line">    CounterCell[] as = counterCells; </span><br><span class="line">    CounterCell a;</span><br><span class="line">    <span class="keyword">long</span> sum = baseCount;</span><br><span class="line">    <span class="comment">// é™¤äº†baseCountä»¥å¤–ï¼Œéƒ¨åˆ†å…ƒç´ å˜åŒ–å­˜å‚¨åœ¨counterCellsæ•°ç»„ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (as != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// éå†æ•°ç»„ç´¯åŠ è·å¾—ç»“æœ</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i < as.length; ++i) {</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                sum += a.value;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="put-putIfAbsentæ–¹æ³•"><a href="#put-putIfAbsentæ–¹æ³•" class="headerlink" title="put/putIfAbsentæ–¹æ³•"></a>put/putIfAbsentæ–¹æ³•</h4><p>ç°åœ¨å¯¹put(putVal)æ–¹æ³•åšä¸€ä¸ªæ€»ç»“:</p>
<ol>
<li>å¦‚æœå¾…æ’å…¥çš„é”®å€¼å¯¹ä¸­ key æˆ– value ä¸º nullï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œç»“æŸã€‚å¦åˆ™æ‰§è¡Œ2</li>
<li>å¦‚æœ table ä¸º nullï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–æ“ä½œ initTable()ï¼Œå¦åˆ™æ‰§è¡Œ3</li>
<li>å¦‚æœ table[i] ä¸ºç©ºï¼Œåˆ™ç”¨ CAS åœ¨ table[i] å¤´ç»“ç‚¹ç›´æ¥æ’å…¥ï¼Œå¦‚æœ CAS æ‰§è¡ŒæˆåŠŸï¼Œé€€å‡ºæ’å…¥æ“ä½œï¼Œæ‰§è¡Œæ­¥éª¤ 7ï¼›å¦‚æœ CAS å¤±è´¥,åˆ™è¯´æ˜æœ‰å…¶ä»–èŠ‚ç‚¹å·²ç»æ’å…¥ï¼Œæ‰§è¡Œ4</li>
<li>æ­¤æ—¶åˆ¤æ–­ï¼Œhash å€¼æ˜¯å¦ä¸º MOVED(-1)ï¼Œå¦‚æœæ˜¯åˆ™è¯´æ˜å…¶ä»–æœ‰å…¶ä»–çº¿ç¨‹åœ¨æ‰§è¡Œæ‰©å®¹æ“ä½œï¼Œå¸®åŠ©ä»–ä»¬ä¸€èµ·æ‰©å®¹ï¼Œæ¥æé«˜æ€§èƒ½ã€‚å¦‚æœæ²¡æœ‰åœ¨æ‰©å®¹,é‚£ä¹ˆæ‰§è¡Œ5</li>
<li>åˆ¤æ–­ hash çš„å€¼ï¼Œå¦‚æœ>=0ï¼Œåˆ™åœ¨é“¾è¡¨åˆé€‚çš„ä½ç½®æ’å…¥ï¼Œå¦åˆ™ï¼ŒæŸ¥çœ‹ table[i] æ˜¯å¦æ˜¯çº¢é»‘æ ‘ç»“æ„ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™åœ¨çº¢é»‘æ ‘é€‚å½“ä½ç½®æ’å…¥ã€‚åˆ°æ­¤æ—¶ï¼Œå€¼å¯¹å·²ç»é¡ºåˆ©æ’å…¥ï¼Œæ¥ä¸‹æ¥æ‰§è¡Œ6</li>
<li>å¦‚æœ table[i] èŠ‚ç‚¹æ•°binCountä¸ä¸º0ï¼Œåˆ¤æ–­å®ƒæ­¤æ—¶çš„çŠ¶æ€,æ˜¯å¦éœ€è¦è½¬å˜ä¸ºçº¢é»‘æ ‘</li>
<li>æ‰§è¡Œ addcount(1L, binCount)</li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>{</span><br><span class="line">    <span class="comment">// æ ¸å¿ƒæ˜¯è°ƒç”¨putValæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">return</span> putVal(key, value, <span class="keyword">false</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">putIfAbsent</span><span class="params">(K key, V value)</span> </span>{</span><br><span class="line">    <span class="comment">// å¦‚æœkeyå­˜åœ¨å°±ä¸æ›´æ–°value</span></span><br><span class="line">    <span class="keyword">return</span> putVal(key, value, <span class="keyword">true</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>{</span><br><span class="line">    <span class="comment">// keyæˆ–value ä¸ºnulléƒ½æ˜¯ä¸å…è®¸çš„ï¼Œå› ä¸ºForwarding Nodeå°±æ˜¯keyå’Œvalueéƒ½ä¸ºnullï¼Œæ˜¯ç”¨ä½œæ ‡å¿—ä½çš„ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="comment">// æ ¹æ®keyè®¡ç®—hashå€¼ï¼Œæœ‰äº†hashå°±å¯ä»¥è®¡ç®—ä¸‹æ ‡äº†</span></span><br><span class="line">    <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// å¯èƒ½éœ€è¦åˆå§‹åŒ–æˆ–æ‰©å®¹ï¼Œå› æ­¤ä¸€æ¬¡æœªå¿…èƒ½å®Œæˆæ’å…¥æ“ä½œï¼Œæ‰€ä»¥æ·»åŠ ä¸Šforå¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> (Node<K,V>[] tab = table;;) {</span><br><span class="line">        Node<K,V> f;  <span class="comment">//ç”¨æ¥å­˜å‚¨è¦æ’å…¥çš„é”®å€¼å¯¹</span></span><br><span class="line">        <span class="comment">// i è¡¨ç¤ºè¦æ’å…¥çš„ä¸‹æ ‡, fh è¡¨ç¤ºè¦è¦æ’å…¥çš„é”®å€¼å¯¹çš„ hash å€¼</span></span><br><span class="line">        <span class="keyword">int</span> n, i, fh; </span><br><span class="line">        <span class="comment">// è¡¨è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–ï¼Œlazily initialized</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            tab = initTable();</span><br><span class="line">        <span class="comment">// æ ¹æ®hashè®¡ç®—åº”è¯¥æ’å…¥çš„index</span></span><br><span class="line">        <span class="comment">// table[i]ä¸ºç©º,ç”¨CASåœ¨table[i]å¤´ç»“ç‚¹ç›´æ¥æ’å…¥,é€€å‡ºæ’å…¥æ“ä½œ;</span></span><br><span class="line">        <span class="comment">// å¦‚æœCASå¤±è´¥,åˆ™æœ‰å…¶ä»–èŠ‚ç‚¹å·²ç»æ’å…¥,ç»§ç»­ä¸‹ä¸€æ­¥</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) & hash)) == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>, <span class="keyword">new</span> Node<K,V>(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// MOVED for forwarding nodes</span></span><br><span class="line">        <span class="comment">// è¯´æ˜fä¸ºForwardingNodeï¼Œåªæœ‰æ‰©å®¹çš„æ—¶å€™æ‰ä¼šæœ‰ForwardingNodeå‡ºç°åœ¨tabä¸­ï¼Œå› æ­¤å¯ä»¥æ–­å®šè¯¥tabæ­£åœ¨è¿›è¡Œæ‰©å®¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)  </span><br><span class="line">            <span class="comment">// ååŠ©æ‰©å®¹            </span></span><br><span class="line">            tab = helpTransfer(tab, f);   </span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            V oldVal = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// å¯¹é“¾è¡¨å¤´ç»“ç‚¹ä¸Šé”</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) </span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) </span><br><span class="line">                {</span><br><span class="line">                    <span class="keyword">if</span> (fh >= <span class="number">0</span>) { <span class="comment">// æ˜¯é“¾è¡¨èŠ‚ç‚¹</span></span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Node<K,V> e = f;; ++binCount) </span><br><span class="line">                        {</span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="comment">// éå†é“¾è¡¨æŸ¥æ‰¾æ˜¯å¦åŒ…å«è¯¥å…ƒç´ </span></span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash && ((ek = e.key) == key || (ek != <span class="keyword">null</span> && key.equals(ek)))) </span><br><span class="line">                            {</span><br><span class="line">                                oldVal = e.val;  <span class="comment">// ä¿å­˜æ—§çš„å€¼ç”¨äºå½“åšè¿”å›å€¼</span></span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    e.val = value;  <span class="comment">// æ›¿æ¢æ—§çš„å€¼ä¸ºæ–°å€¼</span></span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            }</span><br><span class="line">                            Node<K,V> pred = e;</span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) </span><br><span class="line">                            {</span><br><span class="line">                                <span class="comment">// éå†é“¾è¡¨ï¼Œå¦‚æœä¸€ç›´æ²¡æ‰¾åˆ°ï¼Œåˆ™æ–°å»ºä¸€ä¸ªNodeæ”¾åˆ°é“¾è¡¨ç»“å°¾</span></span><br><span class="line">                                pred.next = <span class="keyword">new</span> Node<K,V>(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) <span class="comment">// æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹</span></span><br><span class="line">                    { </span><br><span class="line">                        Node<K,V> p;</span><br><span class="line">                        binCount = <span class="number">2</span>;</span><br><span class="line">                        <span class="comment">// å»çº¢é»‘æ ‘æŸ¥æ‰¾è¯¥å…ƒç´ ï¼Œå¦‚æœæ²¡æ‰¾åˆ°å°±æ·»åŠ ï¼Œæ‰¾åˆ°äº†å°±è¿”å›è¯¥èŠ‚ç‚¹</span></span><br><span class="line">                        <span class="keyword">if</span> ((p = ((TreeBin<K,V>)f).putTreeVal(hash, key, value)) != <span class="keyword">null</span>) {</span><br><span class="line">                            <span class="comment">// ä¿å­˜æ—§çš„valueç”¨äºè¿”å›</span></span><br><span class="line">                            oldVal = p.val;</span><br><span class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                p.val = value; <span class="comment">// æ›¿æ¢æ—§çš„å€¼</span></span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) </span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span> (binCount >= TREEIFY_THRESHOLD)</span><br><span class="line">                    <span class="comment">// é“¾è¡¨é•¿åº¦è¶…è¿‡é˜ˆå€¼ï¼ˆé»˜è®¤ä¸º8ï¼‰ï¼Œåˆ™éœ€è¦å°†é“¾è¡¨è½¬ä¸ºä¸€æ£µçº¢é»‘æ ‘</span></span><br><span class="line">                    treeifyBin(tab, i);</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="comment">// å¦‚æœåªæ˜¯æ›¿æ¢ï¼Œå¹¶æœªå¸¦æ¥èŠ‚ç‚¹çš„å¢åŠ åˆ™ç›´æ¥è¿”å›æ—§çš„valueå³å¯</span></span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// å…ƒç´ æ€»æ•°åŠ 1ï¼Œå¹¶ä¸”åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹</span></span><br><span class="line">    addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="addCountæ–¹æ³•"><a href="#addCountæ–¹æ³•" class="headerlink" title="addCountæ–¹æ³•"></a>addCountæ–¹æ³•</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// check<0ä¸æ£€æŸ¥resize, check<=1åªåœ¨æ²¡æœ‰çº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹æ£€æŸ¥resize</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addCount</span><span class="params">(<span class="keyword">long</span> x, <span class="keyword">int</span> check)</span> </span>{</span><br><span class="line">    CounterCell[] as; </span><br><span class="line">    <span class="keyword">long</span> b, s;</span><br><span class="line">    <span class="comment">// counterCellsæ•°ç»„ä¸ä¸ºnull       </span></span><br><span class="line">    <span class="keyword">if</span> ((as = counterCells) != <span class="keyword">null</span> ||</span><br><span class="line">        <span class="comment">// CASæ›´æ–°BASECOUNTå¤±è´¥ï¼ˆæœ‰å…¶å®ƒçº¿ç¨‹æ›´æ–°äº†BASECOUNTï¼ŒbaseCountå·²ç»ä¸æ˜¯æœ€æ–°å€¼ï¼‰</span></span><br><span class="line">        !U.compareAndSwapLong(<span class="keyword">this</span>, BASECOUNT, b = baseCount, s = b + x)) </span><br><span class="line">    {</span><br><span class="line">        CounterCell a; </span><br><span class="line">        <span class="keyword">long</span> v; </span><br><span class="line">        <span class="keyword">int</span> m;</span><br><span class="line">        <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// counterCellsä¸ºnull</span></span><br><span class="line">        <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) < <span class="number">0</span> ||</span><br><span class="line">            <span class="comment">// counterCellså¯¹åº”ä½ç½®ä¸ºnullï¼Œè¿™é‡Œä¸æ˜¯å¾ˆæ‡‚ï¼Œæœ‰æ²¡æœ‰å¤§ç¥è§£ç­”ä¸‹ï¼Ÿ</span></span><br><span class="line">            <span class="comment">// ThreadLocalRandom.getProbe() è·å¾—çº¿ç¨‹æ¢æµ‹å€¼ï¼Œä»€ä¹ˆç”¨é€”ï¼Ÿ</span></span><br><span class="line">            (a = as[ThreadLocalRandom.getProbe() & m]) == <span class="keyword">null</span> ||</span><br><span class="line">            <span class="comment">// æ›´æ–°CELLVALUEå¤±è´¥</span></span><br><span class="line">            !(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) {</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–counterCells</span></span><br><span class="line">            fullAddCount(x, uncontended);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// counterCells != null æˆ–è€… BASECOUNT CASæ›´æ–°å¤±è´¥éƒ½æ˜¯å› ä¸ºæœ‰çº¿ç¨‹ç«äº‰ï¼Œå› æ­¤ä¸æ£€æŸ¥resize</span></span><br><span class="line">        <span class="keyword">if</span> (check <= <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// ç»Ÿè®¡ä¸‹ConcurrentHashMapå…ƒç´ æ€»æ•°    </span></span><br><span class="line">        s = sumCount();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (check >= <span class="number">0</span>) {</span><br><span class="line">        Node<K,V>[] tab, nt; <span class="keyword">int</span> n, sc;</span><br><span class="line">        <span class="comment">// å…ƒç´ æ€»æ•°å¤§äºsizeCtl</span></span><br><span class="line">        <span class="keyword">while</span> (s >= (<span class="keyword">long</span>)(sc = sizeCtl) && (tab = table) != <span class="keyword">null</span> && (n = tab.length) < MAXIMUM_CAPACITY) {</span><br><span class="line">            <span class="comment">// è·å–ä¸€ä¸ªresizeæ ‡å¿—ä½   </span></span><br><span class="line">            <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">            <span class="comment">// sizeCtl < 0 è¡¨ç¤ºtableæ­£åœ¨åˆå§‹åŒ–æˆ–è€…resize</span></span><br><span class="line">            <span class="keyword">if</span> (sc < <span class="number">0</span>) {</span><br><span class="line">                <span class="keyword">if</span> ((sc >>> RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> || transferIndex <= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                    transfer(tab, nt);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// å½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªå‘èµ·æ‰©å®¹æ“ä½œ</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, (rs << RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">            s = sumCount();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="initTableæ–¹æ³•"><a href="#initTableæ–¹æ³•" class="headerlink" title="initTableæ–¹æ³•"></a>initTableæ–¹æ³•</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * sizeCtlé»˜è®¤ä¸º0ï¼Œå¦‚æœConcurrentHashMapå®ä¾‹åŒ–æ—¶æœ‰ä¼ å‚æ•°ï¼ŒsizeCtlä¼šæ˜¯ä¸€ä¸ª2çš„å¹‚æ¬¡æ–¹çš„å€¼ã€‚</span></span><br><span class="line"><span class="comment"> * æ‰€ä»¥æ‰§è¡Œç¬¬ä¸€æ¬¡putæ“ä½œçš„çº¿ç¨‹ä¼šæ‰§è¡ŒUnsafe.compareAndSwapIntæ–¹æ³•ä¿®æ”¹sizeCtlä¸º-1ï¼Œ</span></span><br><span class="line"><span class="comment"> * æœ‰ä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿä¿®æ”¹æˆåŠŸï¼Œå…¶å®ƒçº¿ç¨‹é€šè¿‡Thread.yield()è®©å‡ºCPUæ—¶é—´ç‰‡ç­‰å¾…tableåˆå§‹åŒ–å®Œæˆã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node<K,V>[] initTable() {</span><br><span class="line">    Node<K,V>[] tab; </span><br><span class="line">    <span class="keyword">int</span> sc;</span><br><span class="line">    <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">if</span> ((sc = sizeCtl) < <span class="number">0</span>) <span class="comment">//sizeCtl ä¸ºè´Ÿå€¼æ—¶ï¼Œè¡¨ç¤ºçº¿ç¨‹åœ¨åˆå§‹åŒ–æˆ–è€…æ‰©å®¹</span></span><br><span class="line">            Thread.yield(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSetInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) {</span><br><span class="line">                    <span class="keyword">int</span> n = (sc > <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                    Node<K,V>[] nt = (Node<K,V>[])<span class="keyword">new</span> Node<?,?>[n];</span><br><span class="line">                    table = tab = nt;</span><br><span class="line">                    sc = n - (n >>> <span class="number">2</span>);</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                sizeCtl = sc;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> tab;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="resizeç›¸å…³æ–¹æ³•ï¼šresizeStampã€helpTransferã€transfer"><a href="#resizeç›¸å…³æ–¹æ³•ï¼šresizeStampã€helpTransferã€transfer" class="headerlink" title="resizeç›¸å…³æ–¹æ³•ï¼šresizeStampã€helpTransferã€transfer"></a>resizeç›¸å…³æ–¹æ³•ï¼šresizeStampã€helpTransferã€transfer</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿”å›ä¸€ä¸ªæ ‡å¿—ä½ï¼Œè¯¥æ ‡å¿—ä½ç»è¿‡RESIZE_STAMP_SHIFTå·¦ç§»å¿…å®šä¸ºè´Ÿæ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">resizeStamp</span><span class="params">(<span class="keyword">int</span> n)</span> </span>{</span><br><span class="line">    <span class="comment">// Integer.numberOfLeadingZerosè¿”å›nå¯¹åº”32ä½äºŒè¿›åˆ¶æ•°å·¦ä¾§0çš„ä¸ªæ•°ï¼Œå¦‚9ï¼ˆ1001ï¼‰è¿”å›28  </span></span><br><span class="line">    <span class="comment">// 1 << (RESIZE_STAMP_BITS - 1) = 2^15ï¼Œå…¶ä¸­RESIZE_STAMP_BITSå›ºå®šä¸º16</span></span><br><span class="line">    <span class="keyword">return</span> Integer.numberOfLeadingZeros(n) | (<span class="number">1</span> << (RESIZE_STAMP_BITS - <span class="number">1</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p> tableæ˜¯ä¸€ä¸ªé“¾è¡¨æ•°ç»„ï¼Œé»˜è®¤ä¸ºç©ºï¼Œåˆå§‹åŒ–æ“ä½œå»¶è¿Ÿåˆ°äº†ç¬¬ä¸€æ¬¡æ‰§è¡Œputï¼Œé»˜è®¤å¤§å°DEFAULT_CAPACITY=16 ,æ‰§è¡Œæ‰©å®¹åï¼Œæ€»ä¸º2çš„næ¬¡å¹‚</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span><<span class="title">K</span>,<span class="title">V</span>> <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span><<span class="title">K</span>,<span class="title">V</span>> </span>{</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    <span class="keyword">volatile</span> V val;</span><br><span class="line">    <span class="keyword">volatile</span> Node<K,V> next;</span><br><span class="line"></span><br><span class="line">    Node(<span class="keyword">int</span> hash, K key, V val) {</span><br><span class="line">        <span class="keyword">this</span>.hash = hash;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.val = val;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    Node(<span class="keyword">int</span> hash, K key, V val, Node<K,V> next) {</span><br><span class="line">        <span class="keyword">this</span>(hash, key, val);</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">getKey</span><span class="params">()</span>     </span>{ <span class="keyword">return</span> key; }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getValue</span><span class="params">()</span>   </span>{ <span class="keyword">return</span> val; }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>{ <span class="keyword">return</span> key.hashCode() ^ val.hashCode(); }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> Helpers.mapEntryToString(key, val);</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">setValue</span><span class="params">(V value)</span> </span>{</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>{</span><br><span class="line">        Object k, v, u; Map.Entry<?,?> e;</span><br><span class="line">        <span class="keyword">return</span> ((o <span class="keyword">instanceof</span> Map.Entry) &&</span><br><span class="line">                (k = (e = (Map.Entry<?,?>)o).getKey()) != <span class="keyword">null</span> &&</span><br><span class="line">                (v = e.getValue()) != <span class="keyword">null</span> &&</span><br><span class="line">                (k == key || k.equals(key)) &&</span><br><span class="line">                (v == (u = val) || v.equals(u)));</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>
<h4 id="putæ–¹æ³•"><a href="#putæ–¹æ³•" class="headerlink" title="putæ–¹æ³•"></a>putæ–¹æ³•</h4><p>ä¸Šé¢æåˆ°ï¼Œåˆå§‹åŒ–æ“ä½œå‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡putæ“ä½œï¼Œé‚£ä¹ˆå¤šä¸ªçº¿ç¨‹æ‰§è¡Œputæ—¶ï¼Œå¦‚ä½•ä¿è¯åªæ‰§è¡Œä¸€æ¬¡åˆå§‹åŒ–å‘¢?</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> putVal(key, value, <span class="keyword">false</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="comment">//è®¡ç®—hashå€¼</span></span><br><span class="line">    <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//å¼€å§‹æ‰§è¡Œæ’å…¥æ“ä½œ</span></span><br><span class="line">    <span class="keyword">for</span> (Node<K,V>[] tab = table;;) {</span><br><span class="line">        Node<K,V> f; </span><br><span class="line">        <span class="keyword">int</span> n, i, fh;</span><br><span class="line">       <span class="comment">//å¦‚æœtableä¸ºç©º,æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            tab = initTable();</span><br><span class="line">        <span class="comment">//table[i]ä¸ºç©º,ç”¨CASåœ¨table[i]å¤´ç»“ç‚¹ç›´æ¥æ’å…¥,é€€å‡ºæ’å…¥æ“ä½œ;å¦‚æœCASå¤±è´¥,åˆ™æœ‰å…¶ä»–èŠ‚ç‚¹å·²ç»æ’å…¥,ç»§ç»­ä¸‹ä¸€æ­¥</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) & hash)) == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,</span><br><span class="line">                         <span class="keyword">new</span> Node<K,V>(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//å¦‚æœtable[i]ä¸ä¸ºç©º,ä¸”table[i]çš„hashå€¼ä¸º-1,åˆ™æœ‰å…¶ä»–çº¿ç¨‹åœ¨æ‰§è¡Œæ‰©å®¹æ“ä½œ,å¸®åŠ©ä»–ä»¬ä¸€èµ·æ‰©å®¹,æé«˜æ€§èƒ½</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">       <span class="comment">//å¦‚æœæ²¡æœ‰åœ¨æ‰©å®¹</span></span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            V oldVal = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">synchronized</span> (f) {</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) {</span><br><span class="line">                    <span class="comment">//fh(table[i])çš„hash>=0,åˆ™æ­¤æ—¶table[i]ä¸ºé“¾è¡¨ç»“æ„,æ‰¾åˆ°åˆé€‚ä½ç½®æ’å…¥</span></span><br><span class="line">                    <span class="keyword">if</span> (fh >= <span class="number">0</span>) {</span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Node<K,V> e = f;; ++binCount) {</span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &&</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                 (ek != <span class="keyword">null</span> && key.equals(ek)))) {</span><br><span class="line">                                oldVal = e.val;</span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    e.val = value;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            }</span><br><span class="line">                            Node<K,V> pred = e;</span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) {</span><br><span class="line">                                pred.next = <span class="keyword">new</span> Node<K,V>(hash, key,</span><br><span class="line">                                                          value, <span class="keyword">null</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                    <span class="comment">//fh(table[i])çš„hash<0,table[i]ä¸ºçº¢é»‘æ ‘ç»“æ„,è¿™ä¸ªè¿‡ç¨‹é‡‡ç”¨åŒæ­¥å†…ç½®é”å®ç°å¹¶å‘</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) {</span><br><span class="line">                        Node<K,V> p;</span><br><span class="line">                        binCount = <span class="number">2</span>;</span><br><span class="line">                        <span class="keyword">if</span> ((p = ((TreeBin<K,V>)f).putTreeVal(hash, key,</span><br><span class="line">                                                       value)) != <span class="keyword">null</span>) {</span><br><span class="line">                            oldVal = p.val;</span><br><span class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                p.val = value;</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }<span class="comment">//åˆ°æ­¤æ—¶,å·²å°†é”®å€¼å¯¹æ’å…¥åˆ°äº†åˆé€‚çš„ä½ç½®,æ£€æŸ¥é“¾è¡¨é•¿åº¦æ˜¯å¦è¶…è¿‡é˜ˆå€¼,è‹¥æ˜¯,åˆ™è½¬å˜ä¸ºçº¢é»‘æ ‘ç»“æ„</span></span><br><span class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) {</span><br><span class="line">                <span class="keyword">if</span> (binCount >= TREEIFY_THRESHOLD)</span><br><span class="line">                    treeifyBin(tab, i);</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//count+1,å¦‚æœ‰å¿…è¦,åˆ™æ‰©å®¹</span></span><br><span class="line">    addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>Java8 ConcurrentHashMapç»“æ„åŸºæœ¬ä¸Šå’ŒJava8çš„HashMapä¸€æ ·ï¼Œä¸è¿‡ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ã€‚</p>
<p>å…¶å®å¯ä»¥çœ‹å‡ºJDK1.8ç‰ˆæœ¬çš„ConcurrentHashMapçš„æ•°æ®ç»“æ„å·²ç»æ¥è¿‘HashMapï¼Œç›¸å¯¹è€Œè¨€ï¼ŒConcurrentHashMapåªæ˜¯å¢åŠ äº†åŒæ­¥çš„æ“ä½œæ¥æ§åˆ¶å¹¶å‘ï¼Œä»JDK1.7ç‰ˆæœ¬çš„ReentrantLock+Segment+HashEntryï¼Œåˆ°JDK1.8ç‰ˆæœ¬ä¸­synchronized+CAS+HashEntry+çº¢é»‘æ ‘ã€‚</p>
<p>1.æ•°æ®ç»“æ„ï¼šå–æ¶ˆäº†Segmentåˆ†æ®µé”çš„æ•°æ®ç»“æ„ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„ç»“æ„ã€‚<br>2.ä¿è¯çº¿ç¨‹å®‰å…¨æœºåˆ¶ï¼šJDK1.7é‡‡ç”¨segmentçš„åˆ†æ®µé”æœºåˆ¶å®ç°çº¿ç¨‹å®‰å…¨ï¼Œå…¶ä¸­segmentç»§æ‰¿è‡ªReentrantLockã€‚JDK1.8é‡‡ç”¨CAS+Synchronizedä¿è¯çº¿ç¨‹å®‰å…¨ã€‚<br>3.é”çš„ç²’åº¦ï¼šåŸæ¥æ˜¯å¯¹éœ€è¦è¿›è¡Œæ•°æ®æ“ä½œçš„SegmentåŠ é”ï¼Œç°è°ƒæ•´ä¸ºå¯¹æ¯ä¸ªæ•°ç»„å…ƒç´ åŠ é”ï¼ˆNodeï¼‰ã€‚<br>4.é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘:å®šä½ç»“ç‚¹çš„hashç®—æ³•ç®€åŒ–ä¼šå¸¦æ¥å¼Šç«¯,Hashå†²çªåŠ å‰§,å› æ­¤åœ¨é“¾è¡¨èŠ‚ç‚¹æ•°é‡å¤§äº8æ—¶ï¼Œä¼šå°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘è¿›è¡Œå­˜å‚¨ã€‚<br>5.æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ï¼šä»åŸæ¥çš„éå†é“¾è¡¨O(n)ï¼Œå˜æˆéå†çº¢é»‘æ ‘O(logN)ã€‚</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ibitm.github.io/2019/12/12/HashMap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20191124213944.png">
      <meta itemprop="name" content="å¼ æ½‡">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±‚ç´¢ä¹‹å¿ƒ">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/12/HashMap/" class="post-title-link" itemprop="url">HashMap</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-12 16:06:14" itemprop="dateCreated datePublished" datetime="2019-12-12T16:06:14+08:00">2019-12-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2019/12/12/HashMap/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/12/12/HashMap/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ–‡çš„éƒ¨åˆ†å†…å®¹å‚è€ƒ<a href="https://link.zhihu.com/?target=https%3A//cyc2018.github.io/CS-Notes/%23/notes/Java%20%E5%AE%B9%E5%99%A8%3Fid%3Dhashmap">cyc2018.github.io/CS-Notes/HashMap</a>ï¼Œç»“åˆæœ¬äººç†è§£å’ŒJDK1.8è¿›è¡Œäº†éƒ¨åˆ†çš„æ›´æ”¹ï¼Œå¦‚æœæœ‰ç†è§£æˆ–è€…ç¼–è¾‘é”™è¯¯ï¼Œæœ›æŒ‡å‡ºã€‚</p>
<h2 id="ä¸€ã€å­˜å‚¨ç»“æ„"><a href="#ä¸€ã€å­˜å‚¨ç»“æ„" class="headerlink" title="ä¸€ã€å­˜å‚¨ç»“æ„"></a>ä¸€ã€å­˜å‚¨ç»“æ„</h2><p>HashMapå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªNodeç±»å‹çš„æ•°ç»„</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> Node<K,V>[] table;</span><br></pre></td></tr></tbody></table></figure>
<p>Node ç±»æ˜¯ HashMap çš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œä¸»è¦æ˜¯ç”±4ä¸ªå­—æ®µï¼Œä» next å­—æ®µæˆ‘ä»¬å¯ä»¥çœ‹å‡º Node æ˜¯ä¸€ä¸ªé“¾è¡¨ã€‚å³æ•°ç»„ä¸­çš„æ¯ä¸ªä½ç½®è¢«å½“æˆä¸€ä¸ªæ¡¶ï¼Œä¸€ä¸ªæ¡¶å­˜æ”¾ä¸€ä¸ªé“¾è¡¨ã€‚HashMap ä½¿ç”¨æ‹‰é“¾æ³•æ¥è§£å†³åœ°å€å†²çªï¼ŒåŒä¸€ä¸ªé“¾è¡¨ä¸­å­˜æ”¾å“ˆå¸Œå€¼å’Œæ•£åˆ—æ¡¶å–æ¨¡è¿ç®—ç»“æœç›¸åŒçš„ Nodeã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span><<span class="title">K</span>,<span class="title">V</span>> <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span><<span class="title">K</span>,<span class="title">V</span>> </span>{</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Node<K,V> next;</span><br><span class="line"></span><br><span class="line">    Node(<span class="keyword">int</span> hash, K key, V value, Node<K,V> next) {</span><br><span class="line">        <span class="keyword">this</span>.hash = hash;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">getKey</span><span class="params">()</span>        </span>{ <span class="keyword">return</span> key; }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getValue</span><span class="params">()</span>      </span>{ <span class="keyword">return</span> value; }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> </span>{ <span class="keyword">return</span> key + <span class="string">"="</span> + value; }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">setValue</span><span class="params">(V newValue)</span> </span>{</span><br><span class="line">        V oldValue = value;</span><br><span class="line">        value = newValue;</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">this</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Map.Entry) {</span><br><span class="line">            Map.Entry<?,?> e = (Map.Entry<?,?>)o;</span><br><span class="line">            <span class="keyword">if</span> (Objects.equals(key, e.getKey()) &&</span><br><span class="line">                    Objects.equals(value, e.getValue()))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ä½¿ç”¨æ‹‰é“¾æ³•è¿›è¡ŒæŸ¥æ‰¾éœ€è¦åˆ†æˆä¸¤æ­¥è¿›è¡Œï¼š</p>
<ul>
<li>è®¡ç®—é”®å€¼å¯¹æ‰€åœ¨çš„æ¡¶ï¼›</li>
<li>åœ¨é“¾è¡¨ä¸Šé¡ºåºæŸ¥æ‰¾ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¾ç„¶å’Œé“¾è¡¨çš„é•¿åº¦æˆæ­£æ¯”ã€‚</li>
</ul>
<h2 id="äºŒã€å¦‚ä½•ç¡®å®šæ¡¶çš„ä¸‹æ ‡"><a href="#äºŒã€å¦‚ä½•ç¡®å®šæ¡¶çš„ä¸‹æ ‡" class="headerlink" title="äºŒã€å¦‚ä½•ç¡®å®šæ¡¶çš„ä¸‹æ ‡"></a>äºŒã€å¦‚ä½•ç¡®å®šæ¡¶çš„ä¸‹æ ‡</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>{</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h >>> <span class="number">16</span>);</span><br><span class="line">}</span><br><span class="line"><span class="comment">//n æ˜¯å½“å‰çš„å®¹é‡</span></span><br><span class="line">p = tab[i = (n - <span class="number">1</span>) & hash]</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¡ç®—å“ˆå¸Œå€¼ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¡ç®—å“ˆå¸Œå€¼ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¡ç®—å“ˆå¸Œå€¼ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¡ç®—å“ˆå¸Œå€¼ï¼Ÿ</h3><p><a href="https://zhuanlan.zhihu.com/p/76784693" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/76784693</a></p>
<h3 id="ä¸ºä»€ä¹ˆé“¾è¡¨æ•°ç»„çš„é•¿åº¦ä¸ºå¶æ•°"><a href="#ä¸ºä»€ä¹ˆé“¾è¡¨æ•°ç»„çš„é•¿åº¦ä¸ºå¶æ•°" class="headerlink" title="ä¸ºä»€ä¹ˆé“¾è¡¨æ•°ç»„çš„é•¿åº¦ä¸ºå¶æ•°"></a>ä¸ºä»€ä¹ˆé“¾è¡¨æ•°ç»„çš„é•¿åº¦ä¸ºå¶æ•°</h3><p>é€šè¿‡hashå€¼è®¡ç®—æ¡¶çš„ä¸‹æ ‡çš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ¬åº”è¯¥æ˜¯</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p = tab[i = hash % n]</span><br></pre></td></tr></tbody></table></figure>
<p>ä½†æ˜¯Javaä¸­çš„å®ç°å´æ˜¯</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p = tab[i = (n - <span class="number">1</span>) & hash]</span><br></pre></td></tr></tbody></table></figure>
<p>ä»¤ x ä¸º 2 çš„ 4 æ¬¡æ–¹ï¼Œå®ƒå…·æœ‰ä»¥ä¸‹æ€§è´¨ï¼š</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x   : 00010000</span><br><span class="line">x-1 : 00001111</span><br></pre></td></tr></tbody></table></figure>
<p>ä»¤ä¸€ä¸ªæ•° y ä¸ x-1 åšã€Œä¸ã€è¿ç®—</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">y       : 10110010</span><br><span class="line">x-1     : 00001111</span><br><span class="line">y & (x-1) : 00000010</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™ä¸ªæ€§è´¨å’Œ y å¯¹ x å–æ¨¡æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼š</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">y   : 10110010</span><br><span class="line">x   : 00010000</span><br><span class="line">y%x : 00000010</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œä½è¿ç®—çš„ä»£ä»·æ¯”æ±‚æ¨¡è¿ç®—å°çš„å¤šï¼Œå› æ­¤åœ¨è¿›è¡Œè¿™ç§è®¡ç®—æ—¶ç”¨ä½è¿ç®—çš„è¯èƒ½å¸¦æ¥æ›´é«˜çš„æ€§èƒ½ã€‚</p>
<h2 id="ä¸‰ã€putæ“ä½œ"><a href="#ä¸‰ã€putæ“ä½œ" class="headerlink" title="ä¸‰ã€putæ“ä½œ"></a>ä¸‰ã€putæ“ä½œ</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,<span class="keyword">boolean</span> evict)</span> </span>{</span><br><span class="line">    Node<K,V>[] tab; </span><br><span class="line">    Node<K,V> p; </span><br><span class="line">    <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="comment">//1.å…ˆåˆ¤æ–­é“¾è¡¨æ•°ç»„æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="comment">//2.ç¡®å®šæ¡¶ä¸‹æ ‡</span></span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) & hash]) == <span class="keyword">null</span>)</span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">//3.ä½¿ç”¨æ‹‰é“¾æ³•è§£å†³åœ°å€å†²çª</span></span><br><span class="line">        Node<K,V> e; </span><br><span class="line">        K k;</span><br><span class="line">        <span class="comment">//3.1åˆ¤æ–­æ˜¯å¦æ˜¯ç›¸åŒçš„keyï¼Œéœ€è¦è¿›è¡Œè¦†ç›–</span></span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash && ((k = p.key) == key || (key != <span class="keyword">null</span> && key.equals(k))))</span><br><span class="line">            e = p;</span><br><span class="line">        <span class="comment">//3.2.1 å¦‚æœå½“å‰æ¡¶çš„é“¾è¡¨å·²ç»è¢«ç»„ç»‡æˆçº¢é»‘æ ‘äº†ï¼Œè°ƒç”¨çº¢é»‘æ ‘çš„putTreeValæ–¹æ³•</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            e = ((TreeNode<K,V>)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">//3.2.2 éå†é“¾è¡¨æ’å…¥èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) {</span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) {</span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (binCount >= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &&((k = e.key) == key || (key != <span class="keyword">null</span> && key.equals(k))))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                p = e;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) { <span class="comment">// existing mapping for key</span></span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                e.value = value;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//4.åˆ¤æ–­æ˜¯å¦æ‰©å®¹</span></span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="keyword">if</span> (++size > threshold)</span><br><span class="line">        resize();</span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å››ã€æ‰©å®¹åé‡æ–°è®¡ç®—ä¸‹æ ‡"><a href="#å››ã€æ‰©å®¹åé‡æ–°è®¡ç®—ä¸‹æ ‡" class="headerlink" title="å››ã€æ‰©å®¹åé‡æ–°è®¡ç®—ä¸‹æ ‡"></a>å››ã€æ‰©å®¹åé‡æ–°è®¡ç®—ä¸‹æ ‡</h2><p>åœ¨è¿›è¡Œæ‰©å®¹æ—¶ï¼Œéœ€è¦æŠŠé”®å€¼å¯¹é‡æ–°æ”¾åˆ°å¯¹åº”çš„æ¡¶ä¸Šã€‚HashMap ä½¿ç”¨äº†ä¸€ä¸ªç‰¹æ®Šçš„æœºåˆ¶ï¼Œå¯ä»¥é™ä½é‡æ–°è®¡ç®—æ¡¶ä¸‹æ ‡çš„æ“ä½œã€‚</p>
<p>å‡è®¾åŸæ•°ç»„é•¿åº¦ capacity ä¸º 16ï¼Œæ‰©å®¹ä¹‹å new capacity ä¸º 32ï¼š</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">capacity     : 00010000</span><br><span class="line">new capacity : 00100000</span><br></pre></td></tr></tbody></table></figure>
<p>å¯¹äºä¸€ä¸ª Keyï¼Œ</p>
<ul>
<li>å®ƒçš„å“ˆå¸Œå€¼å¦‚æœåœ¨ç¬¬ 5 ä½ä¸Šä¸º 0ï¼Œé‚£ä¹ˆæ‰©å®¹åçš„ä¸‹æ ‡å’Œä¹‹å‰ä¸€æ ·ï¼›</li>
<li>å¦‚æœä¸º 1ï¼Œé‚£ä¹ˆæ‰©å®¹åçš„ä¸‹æ ‡ä¸ºåŸæ¥çš„ä¸‹æ ‡ +16ã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢ä»£ç ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((e.hash & oldCap) == <span class="number">0</span>)</span><br><span class="line">    <span class="comment">//è¯´æ˜e.hashå¯¹åº”oldCapäºŒè¿›åˆ¶ä¸º1çš„é‚£ä¸€ä½ä¸º0ï¼Œæ¡¶çš„ä¸‹æ ‡ä¸å˜</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">//ä¸‹æ ‡å˜ä¸ºoldIndex + oldCap</span></span><br></pre></td></tr></tbody></table></figure>
<p>ä¸¾ä¸€ä¸ªå…·ä½“çš„ä¾‹å­</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç¬¬ä¸€ä¸ªé”®å€¼å¯¹çš„hashå€¼çš„äºŒè¿›åˆ¶ä¸º <span class="number">10001</span>(<span class="number">17</span>) å¯¹åº”çš„ä¸‹æ ‡ä¸º <span class="number">17</span> % <span class="number">16</span> =<span class="number">1</span></span><br><span class="line">ç¬¬äºŒä¸ªé”®å€¼å¯¹çš„hashå€¼çš„äºŒè¿›åˆ¶ä¸º <span class="number">00001</span>(<span class="number">1</span>) å¯¹åº”çš„ä¸‹æ ‡ä¸º <span class="number">1</span> % <span class="number">16</span> =<span class="number">1</span></span><br></pre></td></tr></tbody></table></figure>
<p>åŸæ•°ç»„é•¿åº¦ capacity ä¸º 16 æ—¶ï¼Œè¿™ä¸¤ä¸ªé”®å€¼å¯¹éƒ½åº”è¯¥æ”¾åœ¨åŒä¸€ä¸ªæ¡¶é‡Œé¢ï¼Œä½†æ˜¯æ‰©å®¹å</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç¬¬ä¸€ä¸ªé”®å€¼å¯¹çš„hashå€¼çš„äºŒè¿›åˆ¶ä¸º <span class="number">10001</span>(<span class="number">17</span>) å¯¹åº”çš„ä¸‹æ ‡ä¸º <span class="number">17</span> % <span class="number">32</span> = <span class="number">17</span></span><br><span class="line">ç¬¬äºŒä¸ªé”®å€¼å¯¹çš„hashå€¼çš„äºŒè¿›åˆ¶ä¸º <span class="number">00001</span>(<span class="number">1</span>) å¯¹åº”çš„ä¸‹æ ‡ä¸º <span class="number">1</span> % <span class="number">32</span> = <span class="number">1</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="äº”ã€æ‰©å®¹"><a href="#äº”ã€æ‰©å®¹" class="headerlink" title="äº”ã€æ‰©å®¹"></a>äº”ã€æ‰©å®¹</h2><p>è®¾ HashMap çš„ table é•¿åº¦ä¸º Mï¼Œéœ€è¦å­˜å‚¨çš„é”®å€¼å¯¹æ•°é‡ä¸º Nï¼Œå¦‚æœå“ˆå¸Œå‡½æ•°æ»¡è¶³å‡åŒ€æ€§çš„è¦æ±‚ï¼Œé‚£ä¹ˆæ¯æ¡é“¾è¡¨çš„é•¿åº¦å¤§çº¦ä¸º N/Mï¼Œå› æ­¤å¹³å‡æŸ¥æ‰¾æ¬¡æ•°çš„å¤æ‚åº¦ä¸º O(N/M)ã€‚</p>
<p>ä¸ºäº†è®©æŸ¥æ‰¾çš„æˆæœ¬é™ä½ï¼Œåº”è¯¥å°½å¯èƒ½ä½¿å¾— N/M å°½å¯èƒ½å°ï¼Œå› æ­¤éœ€è¦ä¿è¯ M å°½å¯èƒ½å¤§ï¼Œä¹Ÿå°±æ˜¯è¯´ table è¦å°½å¯èƒ½å¤§ã€‚HashMap é‡‡ç”¨åŠ¨æ€æ‰©å®¹æ¥æ ¹æ®å½“å‰çš„ N å€¼æ¥è°ƒæ•´ M å€¼ï¼Œä½¿å¾—ç©ºé—´æ•ˆç‡å’Œæ—¶é—´æ•ˆç‡éƒ½èƒ½å¾—åˆ°ä¿è¯ã€‚</p>
<p>å’Œæ‰©å®¹ç›¸å…³çš„å‚æ•°ä¸»è¦æœ‰ï¼šcapacityã€sizeã€threshold å’Œ load_factorã€‚</p>
<p>capacity</p>
<blockquote>
<p>table çš„å®¹é‡å¤§å°ï¼Œé»˜è®¤ä¸º 16ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ capacity å¿…é¡»ä¿è¯ä¸º 2 çš„ n æ¬¡æ–¹ã€‚</p>
</blockquote>
<p>size</p>
<blockquote>
<p>é”®å€¼å¯¹æ•°é‡</p>
</blockquote>
<p>threshold</p>
<blockquote>
<p>size çš„ä¸´ç•Œå€¼ï¼Œå½“ size å¤§äºç­‰äº threshold å°±å¿…é¡»è¿›è¡Œæ‰©å®¹æ“ä½œã€‚</p>
</blockquote>
<p>loadFactor</p>
<blockquote>
<p>è£…è½½å› å­ï¼Œtable èƒ½å¤Ÿä½¿ç”¨çš„æ¯”ä¾‹ï¼Œthreshold = (int)(newCapacity * loadFactor)ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> << <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">transient</span> Entry[] table;</span><br><span class="line"></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> size;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> threshold;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">float</span> loadFactor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> modCount;</span><br></pre></td></tr></tbody></table></figure>
<p>resize æ–¹æ³•ä¸»è¦ç”¨æ¥åˆå§‹åŒ–é“¾è¡¨æ•°ç»„æˆ–è€…è®©é“¾è¡¨æ•°ç»„çš„é•¿åº¦å˜ä¸ºåŸæ¥çš„2å€.</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node<K,V>[] resize() {</span><br><span class="line">    Node<K,V>[] oldTab = table;</span><br><span class="line">    <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">    <span class="keyword">int</span> oldThr = threshold;</span><br><span class="line">    <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//1.å¦‚æœå®¹é‡ä¸ä¸º0</span></span><br><span class="line">    <span class="keyword">if</span> (oldCap > <span class="number">0</span>) </span><br><span class="line">    {   <span class="comment">//1.1åˆ¤æ–­å®¹é‡æ˜¯å¦å·²ç»åˆ°äº†æœ€å¤§å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (oldCap >= MAXIMUM_CAPACITY) {</span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//1.2 å¦‚æœæ²¡æœ‰åˆ°è¾¾æœ€å¤§å®¹é‡ï¼Œå°±å°†å®¹é‡å˜ä¸ºåŸæ¥çš„2å€</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap << <span class="number">1</span>) < MAXIMUM_CAPACITY && oldCap >= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">            newThr = oldThr << <span class="number">1</span>; </span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldThr > <span class="number">0</span>)  <span class="comment">//å¦‚æœæ˜¯æŒ‡å®šåˆå§‹å®¹é‡çš„è¯ï¼Œä½¿ç”¨é˜ˆå€¼å»åˆå§‹åŒ–->è¿™ç§æ˜¯é’ˆå¯¹æœ‰å‚æ•°çš„æ„é€ æ–¹æ³•</span></span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    <span class="keyword">else</span> {   </span><br><span class="line">        <span class="comment">//2.å¦‚æœæ˜¯åˆå§‹åŒ–ï¼Œä½¿ç”¨DEFAULT_INITIAL_CAPACITYæ¥åˆå§‹åŒ–å®¹é‡</span></span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY; <span class="comment">//16</span></span><br><span class="line">        newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) { <span class="comment">//è¿™ç‚¹æ²¡å¤ªçœ‹æ‡‚</span></span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line">        newThr = (newCap < MAXIMUM_CAPACITY && ft < (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?(<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">    }</span><br><span class="line">    threshold = newThr;</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>({<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>})</span><br><span class="line">    <span class="comment">//3ã€åˆ›å»ºä¸€ä¸ªæ–°çš„é“¾è¡¨æ•°ç»„ï¼Œå¼€å§‹ä¸€ç‚¹ä¸€ç‚¹çš„æ¬è¿</span></span><br><span class="line">        Node<K,V>[] newTab = (Node<K,V>[])<span class="keyword">new</span> Node[newCap];</span><br><span class="line">    table = newTab;</span><br><span class="line">    <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j < oldCap; ++j) {</span><br><span class="line">            Node<K,V> e;</span><br><span class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) {</span><br><span class="line">                oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</span><br><span class="line">                    newTab[e.hash & (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                    ((TreeNode<K,V>)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line">                <span class="keyword">else</span> { <span class="comment">// preserve order</span></span><br><span class="line">                    Node<K,V> loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node<K,V> hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node<K,V> next;</span><br><span class="line">                    <span class="keyword">do</span> {</span><br><span class="line">                        next = e.next;</span><br><span class="line">                        <span class="keyword">if</span> ((e.hash & oldCap) == <span class="number">0</span>) {</span><br><span class="line">                            <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</span><br><span class="line">                                loHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            loTail = e;</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">else</span> {</span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        }</span><br><span class="line">                    } <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) {</span><br><span class="line">                        loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) {</span><br><span class="line">                        hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ibitm.github.io/2019/12/08/%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E7%B3%BB%E7%BB%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20191124213944.png">
      <meta itemprop="name" content="å¼ æ½‡">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±‚ç´¢ä¹‹å¿ƒ">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/08/%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E7%B3%BB%E7%BB%9F/" class="post-title-link" itemprop="url">æ—¥å¿—åˆ†æç³»ç»Ÿ</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-08 15:30:41" itemprop="dateCreated datePublished" datetime="2019-12-08T15:30:41+08:00">2019-12-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index">
                    <span itemprop="name">å¤§æ•°æ®</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2019/12/08/%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E7%B3%BB%E7%BB%9F/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/12/08/%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E7%B3%BB%E7%BB%9F/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="é¡¹ç›®æ¦‚è¿°"><a href="#é¡¹ç›®æ¦‚è¿°" class="headerlink" title="é¡¹ç›®æ¦‚è¿°"></a>é¡¹ç›®æ¦‚è¿°</h2><h2 id="é¡¹ç›®æ‰€ç”¨çš„ç»„ä»¶ç‰ˆæœ¬"><a href="#é¡¹ç›®æ‰€ç”¨çš„ç»„ä»¶ç‰ˆæœ¬" class="headerlink" title="é¡¹ç›®æ‰€ç”¨çš„ç»„ä»¶ç‰ˆæœ¬"></a>é¡¹ç›®æ‰€ç”¨çš„ç»„ä»¶ç‰ˆæœ¬</h2><h2 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h2><p>Zookeeper ä¸¤ä¸ªæœ€é‡è¦çš„ç³»ç»Ÿæ¨¡å‹ï¼šZNode å’Œ Watcher</p>
<h3 id="ZNode"><a href="#ZNode" class="headerlink" title="ZNode"></a>ZNode</h3><p>åœ¨ Zookeeper ä¸­èŠ‚ç‚¹æœ‰ä¸‰ç§ç±»å‹ï¼š</p>
<ul>
<li>æŒä¹…èŠ‚ç‚¹ï¼ˆpersistentï¼‰</li>
<li>ä¸´æ—¶èŠ‚ç‚¹ï¼ˆephemeralï¼‰</li>
<li>é¡ºåºèŠ‚ç‚¹</li>
</ul>
<p>åœ¨èŠ‚ç‚¹åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œé€šè¿‡ç»„åˆä½¿ç”¨ï¼Œå¯æ˜¯ç”Ÿæˆ 4 ç§ç»„åˆå‹èŠ‚ç‚¹</p>
<p><strong>æŒä¹…èŠ‚ç‚¹</strong></p>
<p>æŒä¹…èŠ‚ç‚¹æ˜¯æŒ‡æ•°æ®èŠ‚ç‚¹åˆ›å»ºåï¼Œå°±ä¼šä¸€ç›´å­˜åœ¨ Zookeeper æœåŠ¡å™¨ä¸Šï¼Œç›´åˆ°æœ‰åˆ é™¤æ“ä½œåˆ é™¤è¿™ä¸ªèŠ‚ç‚¹ã€‚</p>
<p><strong>ä¸´æ—¶èŠ‚ç‚¹</strong></p>
<p>ä¸æŒä¹…èŠ‚ç‚¹ä¸åŒï¼Œä¸´æ—¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸä¸å®¢æˆ·ç«¯çš„ä¼šè¯è”ç³»åœ¨ä¸€èµ·ã€‚ä¹Ÿå°±è¯´ï¼Œå¦‚æœå®¢æˆ·ç«¯ä¼šè¯å¤±æ•ˆï¼Œé‚£ä¹ˆè¿™ä¸ªå®¢æˆ·ç«¯åˆ›å»ºçš„ä¸´æ—¶èŠ‚ç‚¹å°±ä¼šè¢«åˆ é™¤ã€‚</p>
<h3 id="Watcher-æ•°æ®å˜æ›´çš„é€šçŸ¥"><a href="#Watcher-æ•°æ®å˜æ›´çš„é€šçŸ¥" class="headerlink" title="Watcher - æ•°æ®å˜æ›´çš„é€šçŸ¥"></a>Watcher - æ•°æ®å˜æ›´çš„é€šçŸ¥</h3><p>Zookeeper é€šè¿‡ Watcher æœºåˆ¶æä¾›äº†ä¸€ç§åˆ†å¸ƒå¼æ•°æ®è®¢é˜…/å‘å¸ƒåŠŸèƒ½ã€‚Zookeeper å…è®¸å®¢æˆ·ç«¯åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæ³¨å†Œä¸€ä¸ª Watcher äº‹ä»¶ç›‘å¬ï¼Œä¸€æ—¦ä¸€äº›äº‹åŠ¡å¯¹è¿™ä¸ªèŠ‚ç‚¹åšä¸€äº›æ“ä½œï¼Œå°±ä¼šè§¦å‘äº†è¿™ä¸ª Watcherï¼Œå®¢æˆ·ç«¯å°±ä¼šæ”¶åˆ°ä¸€ä¸ªäº‹ä»¶é€šçŸ¥ã€‚</p>
<p>ç†è§£äº† ZNode å’Œ Watcher åŸºæœ¬ä¸Šå°±èƒ½å¤§è‡´äº†è§£ Zookeeper çš„è¿è¡Œæœºåˆ¶ã€‚</p>
<h2 id="HBase"><a href="#HBase" class="headerlink" title="HBase"></a>HBase</h2><h3 id="é¢„åˆ†åŒº"><a href="#é¢„åˆ†åŒº" class="headerlink" title="é¢„åˆ†åŒº"></a>é¢„åˆ†åŒº</h3><h3 id="RowKey-è®¾è®¡"><a href="#RowKey-è®¾è®¡" class="headerlink" title="RowKey è®¾è®¡"></a>RowKey è®¾è®¡</h3><p>åœ¨ HBase ä¸­ä¸€æ¡è®°å½•çš„å”¯ä¸€æ ‡è¯†å°±æ˜¯ rowkey ï¼Œé‚£ä¹ˆè¿™æ¡æ•°æ®å­˜å‚¨äºå“ªä¸ª regionï¼Œå–å†³äº rowkey å¤„äºå“ªä¸ªä¸€ä¸ªé¢„åˆ†åŒºçš„åŒºé—´å†…ã€‚</p>
<p><strong>è®¾è®¡ rowkey çš„ä¸»è¦ç›®çš„ ï¼Œå°±æ˜¯è®©æ•°æ®å‡åŒ€çš„åˆ†å¸ƒäºæ‰€æœ‰çš„ region ä¸­ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šé˜²æ­¢æ•°æ®å€¾æ–œã€‚</strong></p>
<h4 id="rowkey-é•¿åº¦åŸåˆ™"><a href="#rowkey-é•¿åº¦åŸåˆ™" class="headerlink" title="rowkey é•¿åº¦åŸåˆ™"></a>rowkey é•¿åº¦åŸåˆ™</h4><p>Rowkey æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶ç æµï¼ŒRowkey çš„é•¿åº¦è¢«å¾ˆå¤šå¼€å‘è€…å»ºè®®è¯´è®¾è®¡åœ¨ 10~100 ä¸ªå­—èŠ‚ï¼Œä¸è¿‡å»ºè®®æ˜¯è¶ŠçŸ­è¶Šå¥½ï¼Œä¸è¦è¶…è¿‡ 16 ä¸ªå­—èŠ‚ï¼Œå­˜ä¸ºbyte[]å­—èŠ‚æ•°ç»„ï¼Œ<strong>ä¸€èˆ¬è®¾è®¡æˆå®šé•¿çš„</strong>ã€‚</p>
<p>åŸå› å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ•°æ®çš„æŒä¹…åŒ–æ–‡ä»¶ HFile ä¸­æ˜¯æŒ‰ç…§ KeyValue å­˜å‚¨çš„ï¼Œå¦‚æœ Rowkey è¿‡é•¿æ¯”å¦‚ 100 ä¸ªå­— èŠ‚ï¼Œ1000 ä¸‡åˆ—æ•°æ®å…‰ Rowkey å°±è¦å ç”¨ 100*1000 ä¸‡=10 äº¿ä¸ªå­—èŠ‚ï¼Œå°†è¿‘ 1G æ•°æ®ï¼Œè¿™ä¼šæå¤§ å½±å“ HFile çš„å­˜å‚¨æ•ˆç‡ï¼›</li>
<li>MemStore å°†ç¼“å­˜éƒ¨åˆ†æ•°æ®åˆ°å†…å­˜ï¼Œå¦‚æœ Rowkey å­—æ®µè¿‡é•¿å†…å­˜çš„æœ‰æ•ˆåˆ©ç”¨ç‡ä¼šé™ä½ï¼Œ ç³»ç»Ÿå°†æ— æ³•ç¼“å­˜æ›´å¤šçš„æ•°æ®ï¼Œè¿™ä¼šé™ä½æ£€ç´¢æ•ˆç‡ã€‚å› æ­¤ Rowkey çš„å­—èŠ‚é•¿åº¦è¶ŠçŸ­è¶Šå¥½ã€‚</li>
<li>ç›®å‰æ“ä½œç³»ç»Ÿæ˜¯éƒ½æ˜¯ 64 ä½ç³»ç»Ÿï¼Œå†…å­˜ 8 å­—èŠ‚å¯¹é½ã€‚æ§åˆ¶åœ¨ 16 ä¸ªå­—èŠ‚ï¼Œ8 å­—èŠ‚çš„æ•´æ•° å€åˆ©ç”¨æ“ä½œç³»ç»Ÿçš„æœ€ä½³ç‰¹æ€§ã€‚</li>
</ol>
<h4 id="rowkey-æ•£åˆ—åŸåˆ™"><a href="#rowkey-æ•£åˆ—åŸåˆ™" class="headerlink" title="rowkey æ•£åˆ—åŸåˆ™"></a>rowkey æ•£åˆ—åŸåˆ™</h4><p>å¦‚æœ Rowkey æ˜¯æŒ‰æ—¶é—´æˆ³çš„æ–¹å¼é€’å¢ï¼Œä¸è¦å°†æ—¶é—´æ”¾åœ¨äºŒè¿›åˆ¶ç çš„å‰é¢ï¼Œå»ºè®®å°† Rowkey çš„é«˜ä½ä½œä¸ºæ•£åˆ—å­—æ®µï¼Œç”±ç¨‹åºå¾ªç¯ç”Ÿæˆï¼Œä½ä½æ”¾æ—¶é—´å­—æ®µï¼Œè¿™æ ·å°†æé«˜æ•°æ®å‡è¡¡åˆ†å¸ƒåœ¨æ¯ä¸ª RegionServer å®ç°è´Ÿè½½å‡è¡¡çš„å‡ ç‡ã€‚</p>
<p>å¦‚æœæ²¡æœ‰æ•£åˆ—å­—æ®µï¼Œé¦–å­—æ®µç›´æ¥æ˜¯æ—¶é—´ä¿¡æ¯å°†äº§ç”Ÿæ‰€æœ‰ æ–°æ•°æ®éƒ½åœ¨ä¸€ä¸ª RegionServer ä¸Šå †ç§¯çš„çƒ­ç‚¹ç°è±¡ï¼Œè¿™æ ·åœ¨åšæ•°æ®æ£€ç´¢çš„æ—¶å€™è´Ÿè½½å°†ä¼šé›†ä¸­ åœ¨ä¸ªåˆ« RegionServerï¼Œé™ä½æŸ¥è¯¢æ•ˆç‡ã€‚</p>
<p>row keyæ˜¯æŒ‰ç…§<strong>å­—å…¸åº</strong>å­˜å‚¨ï¼Œå› æ­¤ï¼Œè®¾è®¡row keyæ—¶ï¼Œè¦å……åˆ†åˆ©ç”¨è¿™ä¸ªæ’åºç‰¹ç‚¹ï¼Œå°†ç»å¸¸ä¸€èµ·è¯»å–çš„æ•°æ®å­˜å‚¨åˆ°ä¸€å—ï¼Œå°†æœ€è¿‘å¯èƒ½ä¼šè¢«è®¿é—®çš„æ•°æ®æ”¾åœ¨ä¸€å—ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼šå¦‚æœæœ€è¿‘å†™å…¥HBaseè¡¨ä¸­çš„æ•°æ®æ˜¯æœ€å¯èƒ½è¢«è®¿é—®çš„ï¼Œå¯ä»¥è€ƒè™‘å°†æ—¶é—´æˆ³ä½œä¸ºrow keyçš„ä¸€éƒ¨åˆ†ï¼Œç”±äºæ˜¯å­—å…¸åºæ’åºï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ <code>Long.MAX_VALUE - timestamp</code> ä½œä¸ºrowkeyï¼Œè¿™æ ·èƒ½ä¿è¯æ–°å†™å…¥çš„æ•°æ®åœ¨è¯»å–æ—¶å¯ä»¥è¢«å¿«é€Ÿå‘½ä¸­ã€‚</p>
<h4 id="rowkey-å”¯ä¸€åŸåˆ™"><a href="#rowkey-å”¯ä¸€åŸåˆ™" class="headerlink" title="rowkey å”¯ä¸€åŸåˆ™"></a>rowkey å”¯ä¸€åŸåˆ™</h4><p>å¿…é¡»åœ¨è®¾è®¡ä¸Šä¿è¯å…¶å”¯ä¸€æ€§ã€‚rowkey æ˜¯æŒ‰ç…§å­—å…¸é¡ºåºæ’åºå­˜å‚¨çš„ï¼Œå› æ­¤ï¼Œè®¾è®¡ rowkey çš„æ—¶å€™ï¼Œè¦å……åˆ†åˆ©ç”¨è¿™ä¸ªæ’åºçš„ç‰¹ç‚¹ï¼Œå°†ç»å¸¸è¯»å–çš„æ•°æ®å­˜å‚¨åˆ°ä¸€å—ï¼Œå°†æœ€è¿‘å¯èƒ½ä¼šè¢«è®¿é—® çš„æ•°æ®æ”¾åˆ°ä¸€å—ã€‚</p>
<p>åœ¨æ—¥å¿—æ•°æ®ä¸­ï¼Œç”¨æˆ· id æœ‰ 16 ä½å·¦å³ï¼Œæ—¶é—´æ˜¯ 8 ä½ï¼Œå½“å‰æ—¶é—´æ˜¯ <code>System.currentTimeMillis()</code>ä¸è¶³16ä½ï¼Œè¡¥ 0. </p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleRowKeyGenerator</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getUUIDKey(String prefix) <span class="keyword">throws</span> UnsupportedEncodingException {</span><br><span class="line">        <span class="keyword">return</span> (prefix + UUID.randomUUID().toString()).getBytes(<span class="string">"UTF8"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getRandomKey(String prefix) <span class="keyword">throws</span> UnsupportedEncodingException {</span><br><span class="line">        <span class="keyword">return</span> (prefix + String.valueOf(<span class="keyword">new</span> Random().nextLong())).getBytes(<span class="string">"UTF8"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getTimestampKey(String prefix) <span class="keyword">throws</span> UnsupportedEncodingException {</span><br><span class="line">        <span class="keyword">return</span> (prefix + String.valueOf(System.currentTimeMillis())).getBytes(<span class="string">"UTF8"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getNanoTimestampKey(String prefix) <span class="keyword">throws</span> UnsupportedEncodingException {</span><br><span class="line">        <span class="keyword">return</span> (prefix + String.valueOf(System.nanoTime())).getBytes(<span class="string">"UTF8"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// è‡ªå®šä¹‰ RowKey</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getKfkRowKey(String userid,String datetime)<span class="keyword">throws</span> UnsupportedEncodingException {</span><br><span class="line">        <span class="keyword">return</span> (userid + datetime + String.valueOf(System.currentTimeMillis())).getBytes(<span class="string">"UTF8"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ibitm.github.io/2019/12/08/The_producer-consumer_model_with_ring_buffers_is_implemented_using_two_types_of_locks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20191124213944.png">
      <meta itemprop="name" content="å¼ æ½‡">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±‚ç´¢ä¹‹å¿ƒ">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/08/The_producer-consumer_model_with_ring_buffers_is_implemented_using_two_types_of_locks/" class="post-title-link" itemprop="url">ä½¿ç”¨ä¸¤ç§é”å®ç°å¸¦æœ‰ç¯å½¢ç¼“å†²åŒºçš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-08 11:03:22" itemprop="dateCreated datePublished" datetime="2019-12-08T11:03:22+08:00">2019-12-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2019/12/08/The_producer-consumer_model_with_ring_buffers_is_implemented_using_two_types_of_locks/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/12/08/The_producer-consumer_model_with_ring_buffers_is_implemented_using_two_types_of_locks/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ä½¿ç”¨synchronizedå…³é”®å­—"><a href="#ä½¿ç”¨synchronizedå…³é”®å­—" class="headerlink" title="ä½¿ç”¨synchronizedå…³é”®å­—"></a>ä½¿ç”¨<code>synchronized</code>å…³é”®å­—</h2><p>æˆ‘ä»¬ä½¿ç”¨<strong>åŒæŒ‡é’ˆ</strong>æ³•æ„å»ºäº†ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºï¼Œä½¿ç”¨ç¯å½¢ç¼“å†²åŒºæœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹</p>
<ul>
<li><p>å…¶ä¸­ head è¡¨ç¤ºç¼“å†²åŒºçš„å¼€å§‹ï¼Œtail è¡¨ç¤ºç¼“å†²åŒºçš„ç»“æŸï¼Œ[head,tail) å‰é—­åå¼€è¡¨ç¤ºç¼“å†²åŒºä¸­æœ‰æ•°æ®çš„ç©ºé—´ã€‚</p>
<ul>
<li>åˆå§‹åŒ– head = tail = 0 è¡¨ç¤ºç¼“å†²åŒºä¸ºç©º</li>
<li>éšç€ç”Ÿäº§ç‰©å“ tail ä¸æ–­çš„å¢åŠ  <code>tail = (tail + 1) % CAPACITY</code></li>
<li>ç›´åˆ° <code>(tail + 1) % CAPACITY == head</code>è¡¨ç¤ºç¼“å†²åŒºæ»¡</li>
</ul>
</li>
<li><p>æœ‰ä¸€ä¸ªç©ºé—´ä¼šè¢«ç©ºç½®ï¼Œä½œä¸ºç¼“å†²åŒºæ»¡çš„åˆ¤æ–­æ ‡å¿—ï¼Œæ‰€ä»¥çœŸæ­£çš„å®¹é‡ä¸º CAPACITY - 1ã€‚</p>
</li>
</ul>
<p>å…¶æ¬¡ï¼Œå…³äº synchronized å…³é”®å­—æœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹</p>
<ul>
<li>synchronized æ˜¯è¦ç»“åˆ <code>Object.wait()</code> å’Œ <code>Object.notify</code> æˆ–è€… <code>Object.notifyAll()</code> ä½¿ç”¨ï¼Œå…·ä½“è¯´æ˜è¯·çœ‹æ–‡ç«  <a href="https://zhuanlan.zhihu.com/p/76625784" target="_blank" rel="noopener">ä¸ºä»€ä¹ˆwait()å’Œnotify()éœ€è¦æ­é…synchonizedå…³é”®å­—ä½¿ç”¨?</a></li>
<li>å› ä¸º synchronized åªæœ‰ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œå½“å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…æ—¶ï¼Œå”¤é†’æ—¶éœ€è¦ä½¿ç”¨ <code>Object.notifyAll()</code></li>
<li>è¿˜æœ‰å°±æ˜¯å¯èƒ½ä¼šå‡ºç°çš„ä¸­æ–­å¼‚å¸¸ InterruptedException ã€‚</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> CAPACITY = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>[] buffer = <span class="keyword">new</span> <span class="keyword">int</span>[CAPACITY];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> head = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> tail = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        <span class="comment">//ç”Ÿäº§è€…</span></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">                <span class="keyword">synchronized</span> (buffer) {</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i < <span class="number">100</span>; i++) {</span><br><span class="line">                        <span class="keyword">while</span> ((tail + <span class="number">1</span>) % CAPACITY == head) {</span><br><span class="line">                            <span class="keyword">try</span> {</span><br><span class="line">                                buffer.wait();</span><br><span class="line">                            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                        buffer[tail] = i;</span><br><span class="line">                        tail = (tail + <span class="number">1</span>) % CAPACITY;</span><br><span class="line">                        System.out.println(<span class="string">"ç”Ÿäº§è€…ç”Ÿäº§äº†"</span> + i);</span><br><span class="line">                        buffer.notifyAll();</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ¶ˆè´¹è€…</span></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">                <span class="keyword">synchronized</span> (buffer) {</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i < <span class="number">100</span>; i++) {</span><br><span class="line">                        <span class="keyword">while</span> (head == tail) {</span><br><span class="line">                            <span class="keyword">try</span> {</span><br><span class="line">                                buffer.wait();</span><br><span class="line">                            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                        System.out.println(<span class="string">"æ¶ˆè´¹è€…æ¶ˆè´¹äº†"</span> + buffer[head]);</span><br><span class="line">                        head = (head + <span class="number">1</span>) % CAPACITY;</span><br><span class="line">                        buffer.notifyAll();</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }).start();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="ä½¿ç”¨ReentrantLockå®ç°"><a href="#ä½¿ç”¨ReentrantLockå®ç°" class="headerlink" title="ä½¿ç”¨ReentrantLockå®ç°"></a>ä½¿ç”¨<code>ReentrantLock</code>å®ç°</h2><p>å¯¹æ¯” ReentrantLock å’Œ synchronized å¯ä»¥çœ‹å‡ºä¸¤è€…çš„å·®åˆ«ï¼ˆæœ€åä¼šæ€»ç»“äºŒè€…çš„åŒºåˆ«ï¼‰</p>
<ul>
<li>synchronized åªèƒ½æœ‰ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œè€Œ ReentrantLock å¯ä»¥é€šè¿‡æ·»åŠ å¤šä¸ªæ¡ä»¶äº’æ–¥é‡å¢åŠ é˜»å¡é˜Ÿåˆ—çš„ä¸ªæ•°</li>
</ul>
<p>ä½¿ç”¨ ReentrantLock æœ‰ä¸€ä¸ªæ³¨æ„çš„åœ°æ–¹ï¼Œè¦åœ¨åœ¨ finally ä¸­å…³é—­é”ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> class <span class="title">test</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">private</span> Lock lock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMethod</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="comment">//code</span></span><br><span class="line">        } </span><br><span class="line">        <span class="keyword">finally</span>{</span><br><span class="line">            lock.unlock();</span><br><span class="line">        }   </span><br><span class="line">    }  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> CAPACITY = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>[] buffer = <span class="keyword">new</span> <span class="keyword">int</span>[CAPACITY];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Condition notFull = lock.newCondition();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Condition notEmpty = lock.newCondition();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> head = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> tail = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        <span class="comment">//ç”Ÿäº§è€…</span></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    lock.lockInterruptibly();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i < <span class="number">100</span>; i++) {</span><br><span class="line">                        <span class="keyword">while</span> ((tail + <span class="number">1</span>) % CAPACITY == head) {</span><br><span class="line">                            <span class="keyword">try</span> {</span><br><span class="line">                                notFull.await();</span><br><span class="line">                            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                        buffer[tail] = i;</span><br><span class="line">                        tail = (tail + <span class="number">1</span>) % CAPACITY;</span><br><span class="line">                        System.out.println(<span class="string">"ç”Ÿäº§è€…ç”Ÿäº§äº†"</span> + i);</span><br><span class="line">                        notEmpty.signal();</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                } <span class="keyword">finally</span> {</span><br><span class="line">                    lock.unlock();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ¶ˆè´¹è€…</span></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    lock.lockInterruptibly();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i < <span class="number">100</span>; i++) {</span><br><span class="line">                        <span class="keyword">while</span> (head == tail) {</span><br><span class="line">                            <span class="keyword">try</span> {</span><br><span class="line">                                notEmpty.await();</span><br><span class="line">                            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                        System.out.println(<span class="string">"æ¶ˆè´¹è€…æ¶ˆè´¹äº†"</span> + buffer[head]);</span><br><span class="line">                        head = (head + <span class="number">1</span>) % CAPACITY;</span><br><span class="line">                        notFull.signal();</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                } <span class="keyword">finally</span> {</span><br><span class="line">                    lock.unlock();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }).start();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="ä¸¤ç§é”çš„åŒºåˆ«"><a href="#ä¸¤ç§é”çš„åŒºåˆ«" class="headerlink" title="ä¸¤ç§é”çš„åŒºåˆ«"></a>ä¸¤ç§é”çš„åŒºåˆ«</h2><h3 id="åŒºåˆ«ä¸€ï¼š"><a href="#åŒºåˆ«ä¸€ï¼š" class="headerlink" title="åŒºåˆ«ä¸€ï¼š"></a>åŒºåˆ«ä¸€ï¼š</h3><p>synchronized æ˜¯é€šè¿‡è™šæ‹Ÿæœºå±‚é¢å®ç°çš„ï¼Œè€Œ ReentrantLock æ˜¯é€šè¿‡ JDK API å®ç°çš„</p>
<h3 id="åŒºåˆ«äºŒï¼šç­‰å¾…å¯ä¸­æ–­"><a href="#åŒºåˆ«äºŒï¼šç­‰å¾…å¯ä¸­æ–­" class="headerlink" title="åŒºåˆ«äºŒï¼šç­‰å¾…å¯ä¸­æ–­"></a>åŒºåˆ«äºŒï¼šç­‰å¾…å¯ä¸­æ–­</h3><p>ç­‰å¾…å¯ä¸­æ–­æ˜¯æŒ‡å½“æŒæœ‰é”çš„çº¿ç¨‹é•¿æœŸä¸é‡Šæ”¾é”çš„æ—¶å€™ï¼Œæ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥é€‰æ‹©æ”¾å¼ƒç­‰å¾…ï¼Œæ”¹ä¸ºå¤„ç†å…¶ä»–äº‹æƒ…ã€‚å¯ç­‰å¾…ç‰¹æ€§å¯¹å¤„ç†æ‰§è¡Œæ—¶é—´éå¸¸é•¿çš„åŒæ­¥å—å¾ˆæœ‰å¸®åŠ©ã€‚</p>
<p>å…·ä½“è¯´æ¥ï¼Œå‡å¦‚ä¸šåŠ¡ä»£ç ä¸­æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼ŒThread1 å’Œ Thread2ã€‚å‡è®¾ Thread1 è·å–äº†å¯¹è±¡é”ï¼ŒThread2 å°†ç­‰å¾… Thread1 é‡Šæ”¾é”ã€‚</p>
<ul>
<li>ä½¿ç”¨synchronizedã€‚å¦‚æœ Thread1 ä¸é‡Šæ”¾ï¼ŒThread2 å°†ä¸€ç›´ç­‰å¾…ï¼Œä¸èƒ½è¢«ä¸­æ–­ã€‚</li>
<li>ä½¿ç”¨ReentrantLockã€‚å¦‚æœ Thread1 ä¸é‡Šæ”¾ï¼ŒThread2 ç­‰å¾…äº†å¾ˆé•¿æ—¶é—´ä»¥åï¼Œå¯ä»¥ä¸­æ–­ç­‰å¾…ï¼Œè½¬è€Œå»åšåˆ«çš„äº‹æƒ…ã€‚</li>
</ul>
<h3 id="åŒºåˆ«ä¸‰ï¼šå…¬å¹³é”"><a href="#åŒºåˆ«ä¸‰ï¼šå…¬å¹³é”" class="headerlink" title="åŒºåˆ«ä¸‰ï¼šå…¬å¹³é”"></a>åŒºåˆ«ä¸‰ï¼šå…¬å¹³é”</h3><p>å…¬å¹³é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹åœ¨ç­‰å¾…åŒä¸€ä¸ªé”æ—¶ï¼Œå¿…é¡»æŒ‰ç…§ç”³è¯·çš„æ—¶é—´é¡ºåºæ¥ä¾æ¬¡è·å¾—é”ï¼›è€Œéå…¬å¹³é”åˆ™ä¸èƒ½ä¿è¯è¿™ä¸€ç‚¹ã€‚éå…¬å¹³é”åœ¨é”è¢«é‡Šæ”¾æ—¶ï¼Œä»»ä½•ä¸€ä¸ªç­‰å¾…é”çš„çº¿ç¨‹éƒ½æœ‰æœºä¼šè·å¾—é”ã€‚ </p>
<ul>
<li><p>synchronizedçš„é”æ˜¯éå…¬å¹³é”</p>
</li>
<li><p>ReentrantLocké»˜è®¤æƒ…å†µä¸‹ä¹Ÿæ˜¯éå…¬å¹³é”ï¼Œä½†å¯ä»¥é€šè¿‡å¸¦ boolean çš„æ„é€ å‡½æ•°è¦æ±‚ä½¿ç”¨å…¬å¹³é”ã€‚</p>
</li>
</ul>
<h3 id="åŒºåˆ«å››ï¼šç»‘å®šå¤šä¸ªæ¡ä»¶"><a href="#åŒºåˆ«å››ï¼šç»‘å®šå¤šä¸ªæ¡ä»¶" class="headerlink" title="åŒºåˆ«å››ï¼šç»‘å®šå¤šä¸ªæ¡ä»¶"></a>åŒºåˆ«å››ï¼šç»‘å®šå¤šä¸ªæ¡ä»¶</h3><p>ReentrantLockå¯ä»¥åŒæ—¶ç»‘å®šå¤šä¸ªConditionå¯¹è±¡ï¼Œåªéœ€å¤šæ¬¡è°ƒç”¨ <code>newCondition()</code> æ–¹æ³•å³å¯ã€‚</p>
<p>synchronizedä¸­ï¼Œé”å¯¹è±¡çš„ <code>wait()</code> å’Œ <code>notify()</code>  æˆ– <code>notifyAll()</code> æ–¹æ³•å¯ä»¥å®ç°ä¸€ä¸ªéšå«çš„æ¡ä»¶ã€‚å¦‚æœéœ€è¦å¤šä¸ªæ¡ä»¶ï¼Œåªèƒ½å¤šåŠ é”ã€‚</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ibitm.github.io/2019/12/05/%E4%B8%93%E4%B8%9A%E4%B9%A6%E7%B1%8D%E5%A4%87%E5%BF%98%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20191124213944.png">
      <meta itemprop="name" content="å¼ æ½‡">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±‚ç´¢ä¹‹å¿ƒ">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/05/%E4%B8%93%E4%B8%9A%E4%B9%A6%E7%B1%8D%E5%A4%87%E5%BF%98%E5%BD%95/" class="post-title-link" itemprop="url">ä¸“ä¸šä¹¦ç±å¤‡å¿˜å½•</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-05 19:52:22" itemprop="dateCreated datePublished" datetime="2019-12-05T19:52:22+08:00">2019-12-05</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2019/12/05/%E4%B8%93%E4%B8%9A%E4%B9%A6%E7%B1%8D%E5%A4%87%E5%BF%98%E5%BD%95/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/12/05/%E4%B8%93%E4%B8%9A%E4%B9%A6%E7%B1%8D%E5%A4%87%E5%BF%98%E5%BD%95/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="https://github.com/IBITM/ibitm.github.io/blob/master/img/%E5%AD%A6%E4%B9%A0%E4%B9%A6%E7%B1%8D.png?raw=true" alt></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ibitm.github.io/2019/12/05/%E4%BB%8EComparable%E5%88%B0compareTo%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20191124213944.png">
      <meta itemprop="name" content="å¼ æ½‡">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±‚ç´¢ä¹‹å¿ƒ">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/05/%E4%BB%8EComparable%E5%88%B0compareTo%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">ä»Comparableåˆ°compareToæ–¹æ³•</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-05 16:47:20" itemprop="dateCreated datePublished" datetime="2019-12-05T16:47:20+08:00">2019-12-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" itemprop="url" rel="index">
                    <span itemprop="name">æ•°æ®ç»“æ„ä¸ç®—æ³•</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2019/12/05/%E4%BB%8EComparable%E5%88%B0compareTo%E6%96%B9%E6%B3%95/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/12/05/%E4%BB%8EComparable%E5%88%B0compareTo%E6%96%B9%E6%B3%95/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>ä»Šå¤©åˆ·LeetCode <a href="https://leetcode-cn.com/problems/largest-number/" target="_blank" rel="noopener">179. æœ€å¤§æ•°</a> éœ€è¦ç”¨åˆ° String ç±»å‹çš„æ’åºé—®é¢˜ï¼Œå°±å…·ä½“çœ‹äº†ä¸€ä¸‹ Java çš„å®ç°æ–¹æ³•</p>
<p>String æ˜¯å®ç°äº† Comparable æ¥å£ï¼ŒComparable æ¥å£é‡Œé¢åªæœ‰ä¸€ä¸ªæ–¹æ³•å°±æ˜¯ compareTo æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(String anotherString)</span> </span>{xxx}</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ–‡æ¡£è¯´æ˜</p>
<blockquote>
<p>æŒ‰å­—å…¸é¡ºåºæ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²ã€‚æ¯”è¾ƒæ˜¯åŸºäºå­—ç¬¦ä¸²ä¸­æ¯ä¸ªå­—ç¬¦çš„ Unicode å€¼ã€‚</p>
<p>å¦‚æœæœ¬èº«å­—ç¬¦ä¸²å¯¹è±¡çš„å­—å…¸åºåœ¨å‚æ•°å­—ç¬¦ä¸²ä¹‹å‰è¿”å›è´Ÿæ•´æ•°ï¼Œä¹‹åè¿”å›æ­£æ•´æ•°ï¼Œç›¸åŒè¿”å› 0ã€‚</p>
</blockquote>
<p>å­—å…¸åºæ˜¯ä»€ä¹ˆï¼Œè¿”å›å€¼æ˜¯æ€ä¹ˆç¡®å®šçš„å‘¢ï¼Ÿ</p>
<blockquote>
<p>å¦‚æœä¸¤ä¸ªå­—ç¬¦ä¸²å­—å…¸åºä¸åŒï¼Œåˆ™å®ƒä»¬</p>
<ul>
<li>è¦ä¹ˆåœ¨æŸä¸ªç´¢å¼•å¤„å…·æœ‰ä¸åŒçš„å­—ç¬¦ï¼ˆç´¢å¼•å¿…é¡»æ˜¯ä¸¤ä¸ªå­—ç¬¦ä¸²çš„æœ‰æ•ˆç´¢å¼•ï¼‰ï¼Œ</li>
<li>è¦ä¹ˆå®ƒä»¬çš„é•¿åº¦ä¸åŒ</li>
<li>æˆ–è€…ä»¥ä¸Šä¸¤è€…éƒ½å­˜åœ¨</li>
</ul>
<p>è¿”å›å€¼ç¡®å®šå¦‚ä¸‹:</p>
<ul>
<li>å¦‚æœå®ƒä»¬åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªç´¢å¼•ä½ç½®å…·æœ‰ä¸åŒçš„å­—ç¬¦ï¼Œå‡è®¾ k è¡¨ç¤ºç¬¬ä¸€ä¸ªä¸ç›¸åŒå­—ç¬¦ï¼Œè¿”å›ä¸¤ä¸ªå­—ç¬¦çš„å·® <code>this.charAt(k)-anotherString .charAt(k)</code></li>
<li>å¦‚æœæ²¡æœ‰å­—ç¬¦ä¸åŒï¼Œåˆ™æŒ‰å­—å…¸é¡ºåºï¼Œè¾ƒçŸ­çš„å­—ç¬¦ä¸²åœ¨è¾ƒé•¿çš„å­—ç¬¦ä¸²ä¹‹å‰ï¼Œè¿”å› <code>this.length()-anotherString.length()</code></li>
</ul>
</blockquote>
<p>æˆ‘ä»¬æ‹¿å‡ºä¸€ä¸ªå®ç°ç‰ˆæœ¬çœ‹ä¸€ä¸‹å®ƒçš„å®ç°é€»è¾‘</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(<span class="keyword">byte</span>[] value, <span class="keyword">byte</span>[] other, <span class="keyword">int</span> len1, <span class="keyword">int</span> len2)</span> </span>{</span><br><span class="line">    <span class="keyword">int</span> lim = Math.min(len1, len2);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k < lim; k++) {</span><br><span class="line">        <span class="keyword">if</span> (value[k] != other[k]) {</span><br><span class="line">            <span class="keyword">return</span> getChar(value, k) - getChar(other, k);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> len1 - len2;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ibitm.github.io/2019/12/03/%E4%BB%8EACID%E5%88%B0CAP-BASE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20191124213944.png">
      <meta itemprop="name" content="å¼ æ½‡">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±‚ç´¢ä¹‹å¿ƒ">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/03/%E4%BB%8EACID%E5%88%B0CAP-BASE/" class="post-title-link" itemprop="url">ä»ACIDåˆ°CAP/BASE</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-03 21:01:40" itemprop="dateCreated datePublished" datetime="2019-12-03T21:01:40+08:00">2019-12-03</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2019/12/03/%E4%BB%8EACID%E5%88%B0CAP-BASE/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/12/03/%E4%BB%8EACID%E5%88%B0CAP-BASE/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="å¼ æ½‡"
      src="/uploads/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20191124213944.png">
  <p class="site-author-name" itemprop="name">å¼ æ½‡</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">28</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ibitm" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;ibitm" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/mailto:875080958@qq.com" title="E-Mail â†’ mailto:875080958@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://www.zhihu.com/people/zhang-xiao-61-53/activities" title="zhihu â†’ http:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;zhang-xiao-61-53&#x2F;activities" rel="noopener" target="_blank"><i class="fa fa-fw fa-zhihu"></i>zhihu</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">å¼ æ½‡</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> å¼ºåŠ›é©±åŠ¨ v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">ä¸»é¢˜ â€“ <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.5.0
  </div>

        








        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>













  

  

  


<script>
NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: '59jSyrRz5vygBBEppvd4Inud-MdYXbMMI',
    appKey: '14TLHCXpYXedwKjmamiT2knn',
    placeholder: "Just go go",
    avatar: 'retro',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: '' || 'zh-cn',
    path: location.pathname,
    recordIP: false,
    serverURLs: ''
  });
}, window.Valine);
</script>

</body>
</html>
